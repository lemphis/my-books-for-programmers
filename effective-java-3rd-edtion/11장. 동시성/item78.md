# 78. 공유 중인 가변 데이터는 동기화해 사용하라

`synchronized` 키워드는 해당 메서드나 블록을 한 번에 한 스레드씩 수행하도록 보장한다.  
많은 프로그래머가 동기화를 배타적 실행, 즉 한 스레드가 보지 못하게 막는 용도로만 생각한다.  
맞는 설명이지만, 동기화에는 중요한 기능이 하나 더 있다.  
동기화는 일관성이 깨진 상태를 볼 수 없게 하는 것은 물론, 동기화된 메서드나 블록에 들어간 스레드가 같은 락의 보호하에 수행된 모든 이전 수정의 최종 결과를 보여준다.

언어 명세상 long과 double 외의 변수를 읽고 쓰는 것은 원자적(atomic)이다.  
여러 스레드가 같은 변수를 동기화 없이 수정하는 중이라도, 항상 어떤 스레드가 정상적으로 저장한 값을 온전히 읽어옴을 보장한다는 뜻이다.  
이 말을 듣고 "성능을 높이려면 원자적 데이터를 읽고 쓸 때는 동기화하지 말아야겠다"고 생각하기 쉬운데, 아주 위험한 발상이다.  
자바 언어 명세는 스레드가 필드를 읽을 떼 항상 '수정이 완전히 반영된' 값을 얻는다고 보장하지만, 한 스레드가 저장한 값이 다른 스레드에게 '보이는가'는 보장하지 않는다.  
**동기화는 배타적 실행뿐 아니라 스레드 사이의 안정적인 통신에 꼭 필요하다.**  
이는 한 스레드가 만든 변화가 다른 스레드에게 언제 어떻게 보이는지를 규정한 자바의 메모리 모델 때문이다.

**쓰기와 읽기 모두가 동기화되지 않으면 동작을 보장하지 않는다.**

`volatile` 한정자는 배타적 수행과는 상관없지만 항상 가장 최근에 기록된 값을 읽게 됨을 보장한다. (배타적 실행은 필요 없고, 스레드끼리의 통신만 필요할 때 사용)

이번 아이템에서 언급한 문제들을 피하는 가장 좋은 방법은 물론 애초에 가변 데이터를 공유하지 않는 것이다.  
불변 데이터만 공유하거나 아무것도 공유하지 말자. (가변 데이터는 단일 스레드에서만 쓰도록 하자)