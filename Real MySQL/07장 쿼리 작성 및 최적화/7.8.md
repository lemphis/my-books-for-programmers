# 7.8 스키마 조작 (DDL)

데이터베이스 구조 및 정의를 생성하거나 변경하는 쿼리를 `DDL(Data Definition Language)`이라고 한다.  
스토어드 프로시저나 함수, DB나 테이블 등을 생성하거나 변경하는 대부분의 명령이 DDL에 해당한다.  
이런 DDL 가운데 **인덱스나 칼럼을 추가하고 삭제하는 작업은 테이블의 모든 레코드를 임시 테이블로 복사하면서 처리되므로 매우 주의**해야 한다.

## 7.8.1 데이터베이스

MySQL에서는 하나의 인스턴스는 1개 이상의 데이터베이스를 가질 수 있는데, MySQL의 데이터베이스는 단순히 테이블을 모아서 그룹으로 만들어 둔다는 개념으로 사용한다.

## 7.8.2 테이블

### 테이블 생성

TEMPORARY 키워드를 사용하면 해당 데이터베이스 커넥션(세션)에서만 사용 가능한 임시 테이블을 생성한다.

각 칼럼은 "칼럼명 + 칼럼 타입 + \[타입별 옵션\] + \[NULL 여부\] + \[기본값\]"의 순서대로 명시하고, 각 타입별로 다음과 같은 옵션을 추가로 사용할 수 있다.

- 모든 칼럼은 공통적으로 칼럼의 초깃값을 명시하는 DEFAULT 절과, 칼럼이 NULL이 될 수 있는지를 나타내고자 NULL 또는 NOT NULL 제약을 명시할 수 있음
- 문자열 타입
  - 반드시 칼럼에 최대한 저장할 수 있는 문자 수를 명시해야 함
  - CHARACTER SET 절은 칼럼에 저장되는 문자열 값이 어떤 문자 집합을 사용할지를 결정하고, COLLATE로 비교나 정렬 규칙을 나타내고자 콜레이션 설정 가능
- 숫자 타입
  - 선택적으로 길이를 가질 수 있지만, 이는 실제 칼럼에 저장될 값의 길이를 의미하는 것이 아님
  - 양수만 가질지 음수와 양수를 모두 저장할지에 따라 선택적으로 UNSIGNED 키워드 명시 가능 (기본 값: SIGNED)
  - 숫자 값의 왼쪽에 '0'을 패딩 하려면 ZEROFILL 키워드 사용
- 날짜 타입
  - DATE, DATETIME은 특별히 명시할 수 있는 옵션 없음
  - TIMESTAMP는 어떤 조작을 할 때 값이 자동으로 현재 시간으로 업데이트할지를 결정하는 옵션 추가 명시 가능
- ENUM, SET
  - 타입의 이름 뒤에 해당 칼럼이 가질 수 있는 값을 괄호로 정의해야 함

### 테이블 구조

테이블의 구조를 변경하려면 `ALTER TABLE` 명령을 사용한다.  
ALTER TABLE 명령은 테이블 자체의 속성을 변경할 수 있을뿐더러 인덱스의 추가/삭제나 칼럼을 추가/삭제하는 용도로도 사용된다.

테이블의 문자 집합을 변경하는 명령은 테이블 내에 이미 존재하는 칼럼의 문자 집합을 변경하는 것이 아니고 앞으로 추가될 칼럼의 기본 문자 집합만 변경하는 명령이다.  

스토리지 엔진을 변경하는 명령은 내부적인 테이블의 저장소를 변경하는 것이라서 항상 테이블의 모든 레코드를 복사하는 작업이 필요하다.  
이 명령은 실제 테이블의 스토리지 엔진을 변경하는 목적으로도 사용되지만, 테이블 데이터를 리빌드하는 목적으로도 사용된다.  
테이블 리빌드 작업은 주로 레코드의 삭제가 자주 발생하는 테이블에서 데이터가 저장되지 않은 빈 공간(프래그멘테이션, Fragmentation)을 제거해 디스크의 공간을 줄이는 역할을 한다.

### RENAME TABLE

MySQL에서는 RENAME TABLE 명령을 실행할 때 네임 락(Name Lock)이라는 잠금을 사용하여 RENAME TABLE 명령에 있는 모든 테이블에 대해 한 번에 잠금을 걸고 작업을 진행한다.  

RENAME TABLE 명령은 시스템적으로(운영체제 레벨에서) 원자성(Atomicity) 작업이 아니다.  

- MyISAM: \*.FRM, \*.MYD, \*.MYI 파일 이름 변경 필요
- InnoDB: \*.FRM 파일 이름 변경과 InnoDB 스토리지 엔진 내에서 관리되는 딕셔너리 정보의 변경 필요

### 테이블 삭제

일반적으로 MySQL에서 레코드가 많지 않은 테이블을 삭제하는 작업은 서비스 도중이라 하더라도 문제 되지 않는다.  
레코드 건수가 많은 테이블을 삭제하는 작업은 상당히 부하가 큰 작업에 속한다.

MySQL에서 테이블을 삭제하려면 반드시 LOCK_open이라는 잠금을 획득해야 한다.

## 7.8.3 칼럼 변경

### 칼럼 추가

MySQL에서 칼럼을 추가하는 작업은 항상 테이블의 데이터를 새로운 테이블로 복사하는 형태로 처리된다.  
따라서 테이블의 레코드 건수가 많아질수록 칼럼 추가 작업이 느려진다.

### 칼럼 삭제

칼럼을 삭제하는 작업도 테이블의 데이터를 새로운 테이블로 복사하면서 칼럼을 제거하는 형태로 처리된다.

## 7.8.4 인덱스 변경

### 인덱스 추가

MySQL 5.0 이하의 버전에서는 테이블의 모든 레코드를 복사하는 형태로 인덱스를 생성하는 작업이 처리됐다.  
MySQL 5.1이나 5.5의 MyISAM 테이블에서 인덱스를 생성하는 작업은 MySQL 5.0과 마찬가지로 임시 테이블로 복사하는 형태로 처리된다.  
하지만 InnoDB 테이블에 대해서는 MySQL 5.1 InnoDB 플러그인 버전부터 데이터 자체는 그대로 두고, 인덱스만 생성하는 형태로 개선됐다.

인덱스를 새로 생성할 때도 ALTER TABLE 명령을 이용하는데, 이때 ADD 키워드 뒤에 인덱스 종류를 명시한다.  
가능한 인덱스의 종류는 다음과 같다.

- PRIMARY KEY
  - 테이블의 프라이머리 키를 생성하는 키워드
  - 테이블이 어떤 스토리지 엔진이든지 사용 가능
- UNIQUE INDEX
  - 키값의 중복을 허용하지 않는 인덱스를 생성하는 키워드
  - 테이블이 어떤 스토리지 엔진이든지 사용 가능
- FULLTEXT INDEX
  - 전문 검색 인덱스를 생성하는 키워드
  - MyISAM 스토리지 엔진을 사용하는 테이블에서만 사용 가능
- SPATIAL INDEX
  - 공간 검색 인덱스를 생성하는 키워드
  - MyISAM 스토리지 엔진을 사용하는 테이블에서만 사용 가능
- INDEX
  - 중복이 허용되는 일반 보조 인덱스를 생성하는 키워드
  - 테이블이 어떤 스토리지 엔진이든지 사용 가능

FULLTEXT나 SPATIAL 인덱스 이외에는 USING 키워드를 이용해 어떤 인덱스 알고리즘을 사용할지 명시할 수 있다.  
인덱스 알고리즘은 일반적으로 `B-Tree`나 `HASH`가 사용된다.  
만약 USING 절을 명시하지 않으면 각 스토리지 엔진별로 기본 인덱스 알고리즘이 사용된다.  
MyISAM과 InnoDB 테이블에 대해서는 B-Tree 인덱스가 기본으로 생성되며, MEMORY 테이블이나 NDB 클러스터 테이블에 대해서는 HASH 인덱스가 생성된다.

### 인덱스 삭제

MySQL 5.0 이하의 버전에서는 인덱스를 삭제하는 작업도 테이블 자체를 복사하면서 처리했기 때문에 인덱스를 생성하는 작업과 거의 비슷한 시간이 걸렸다.  
MySQL 5.1이나 5.5에서 MyISAM 테이블은 인덱스 생성이나 삭제 모두 기존 MySQL 5.0의 방식과 같다.  
하지만 InnoDB 테이블은 MySQL 5.1 InnoDB 플러그인 버전부터 데이터 자체는 그대로 두고 인덱스만 삭제하기 때문에 MySQL 5.0의 방식보다 훨씬 빠르게 처리한다.  
예외적으로, InnoDB의 프라이머리 키 삭제는 MySQL 5.0에서처럼 테이블의 모든 레코드를 복사하면서 처리된다.  
이는 InnoDB의 프라이머리 키가 클러스터링 키이기 때문에 피할 수 없는 부분이다.

## 7.8.5 프로세스 조회

MySQL 서버에 접속된 사용자의 목록이나 각 클라이언트 사용자가 현재 어떤 쿼리를 실행하고 있는지는 `SHOW PROCESSLIST` 명령으로 확인할 수 있다.  
SHOW PROCESSLIST 명령의 결과에는 현재 MySQL 서버에 접속된 클라이언트의 요청을 처리하고 있는 스레드 수만큼의 레코드가 표시된다.  
각 칼럼에 포함된 값의 의미는 다음과 같다.

- Id: MySQL 서버의 스레드 아이디이며, 쿼리나 커넥션을 강제 종료시킬 때 이 아이디 값을 식별자로 사용
- User: 클라이언트가 MySQL 서버에 접속할 때 인증에 사용한 사용자 계정
- Host: 클라이언트의 호스트명이나 IP 주소
- db: 클라이언트가 기본적으로 사용하고 있는 데이터베이스 이름
- Command: 해당 스레드가 현재 어떤 작업을 처리하고 있는지 표시
- Time: Command 칼럼에 표시되는 작업이 얼마나 실행되고 있는지 표시
- State: Command 칼럼에 표시되는 내용이 해당 스레드가 처리하고 있는 작업의 큰 분류라면, State 칼럼에는 소분류 작업 내용을 표시
- Info: 해당 스레드가 실행 중인 쿼리 문장 표시

## 7.8.6 프로세스 강제 종료

특정 스레드에서 실행 중인 쿼리나 커넥션 자체를 강제 종료하려면 `KILL` 명령을 사용하면 된다.

```sql
KILL QUERY 4228;
KILL 4228;
```

위 예시의 첫 번째 명령은 아이디가 4228인 스레드가 실행 중인 쿼리만 강제 종료시키는 명령이다.  
두 번째 명령은 해당 4228번 스레드가 실행하고 있는 쿼리뿐 아니라 해당 스레드까지 강제 종료시키는 명령이다.  
스레드를 강제 종료시키면 그 스레드가 담당하고 있던 커넥션도 강제 종료된다.  
커넥션까지 강제 종료하면 그 커넥션에서 처리하고 있던 트랜잭션이 정상적으로 종료되지 않을 수 있다.

## 7.8.7 시스템 변수 조회 및 변경

MySQL 서버가 기동하면 기본 설정 파일(my.cnf나 my.ini)이나 명령행 인자를 통해 읽어들인 설정값을 시스템 변수라고 한다.  
이러한 시스템 변수는 `SHOW VARIABLES`라는 명령으로 조회할 수 있다.

## 7.8.8 경고나 에러 조회

쿼리를 실행하는 도중 에러가 발생하면 쿼리의 실행을 중지하고, 에러 메시지를 화면에 자동으로 표시해 준다.  
하지만 에러가 아니라 경고나 정보성 메시지는 출력되지 않고, 경고나 정보성 메시지가 몇 개 발생했는지만 보여준다.  
일반적으로 많은 사용자들이 경고성 메시지를 무시해버리지만, 사실 칼럼의 공간 부족으로 값이 잘려서 저장되거나, NULL로 저장됐다거나 하는 메시지도 있을 수 있다.  
경고 메시지를 조회하려면 `SHOW WARNINGS` 명령을 사용하면 된다.

## 7.8.9 권한 조회

MySQL 서버에서 사용할 수 있는 모든 종류의 권한은 `SHOW PRIVILEGES` 명령으로 조회할 수 있다.  
SHOW PRIVILEGES 명령을 사용하면 사용자에게 부여할 수 있는 모든 권한의 이름과 간단한 설명이 표시된다.  
특정 사용자가 가지고 있는 권한을 조회해 보려면 `SHOW GRANTS` 명령을 사용하면 된다.
