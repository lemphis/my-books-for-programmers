# 7.10 쿼리 성능 테스트

## 7.10.1 쿼리의 성능에 영향을 미치는 요소

직접 작성한 쿼리를 실행해 보고 성능을 판단할 때 가장 큰 변수는 MySQL 서버가 가지고 있는 여러 종류의 버퍼나 캐시일 것이다.

- 운영체제의 캐시
  - MySQL 서버는 운영체제의 파일 시스템 관련 기능(시스템 콜)을 이용해 데이터 파일을 읽음
  - 대부분의 운영체제는 한 번 읽은 데이터는 운영체제가 관리하는 별도의 캐시 영역에 보관해 뒀다가 다시 해당 데이터가 요청되면 디스크를 읽지 않고 캐시의 내용을 MySQL 서버로 반환함
  - InnoDB 스토리지 엔진은 일반적으로 파일 시스템의 캐시나 버퍼를 거치지 않는 Direct I/O를 사용하므로 운영체제의 캐시가 큰 영향을 미치지 않음
  - MyISAM 스토리지 엔진은 운영체제의 캐시에 대한 의존도가 높아서 운영체제의 캐시에 따라 성능 차이가 큰 편임
  - 운영체제에 포함된 캐시나 버퍼는 프로그램 단위로 관리되기 때문에 프로그램(MySQL 서버)이 종료되면 해당 프로그램을 위한 캐시는 자동적으로 해제됨
- MySQL 서버의 버퍼 풀 (InnoDB 버퍼 풀고 MyISAM의 키 캐시)
  - 운영체제의 버퍼나 캐시와 마찬가지로 MySQL 서버에서도 데이터 파일의 내용을 페이지(또는 블록) 단위로 캐시 하는 기능을 제공함
  - InnoDB
    - InnoDB 스토리지 엔진이 관리하는 캐시를 버퍼 풀이라고 함
    - 버퍼 풀은 인덱스 페이지는 물론이고 데이터 페이지까지 캐시 하며, 쓰기 작업을 위한 버퍼링 작업까지 겸해서 처리함
  - MyISAM
    - MyISAM 스토리지 엔진이 관리하는 캐시는 키 캐시라고 함
    - 키 캐시는 인덱스 데이터에 대해서만 캐시 제공
    - 주로 읽기를 위한 캐시 역할을 수행하며, 제한적으로 인덱스 변경만을 위한 버퍼 역할 제공
    - 인덱스를 제외한 테이블 데이터는 모두 운영체제의 캐시에 의존할 수밖에 없음
- MySQL 쿼리 캐시
  - 이전에 실행됐던 SQL 문장과 그 결과를 임시로 저장해두는 메모리 공간을 의미
  - 어떤 쿼리 결과가 이미 쿼리 캐시에 있었다면 그 쿼리는 전체 실행 과정을 건너뛰기 때문에 실제 부하와 관계없이 아주 빠르게 처리됨
  - 쿼리 캐시에 저장된 데이터를 비우려면 "RESET QUERY CACHE" 명령을 이용하면 되는데, 삭제 작업이 진행되는 동안 모든 쿼리의 실행이 대기해야 함

실제 쿼리의 성능 테스트를 MySQL 서버의 상태가 워밍업 된 상태(캐시나 버퍼가 필요한 데이터로 준비된 상태)에서 진행할지 아니면 콜드 상태(캐시나 버퍼가 모두 초기화된 상태)에서 진행할지도 고려해야 한다.  
**일반적으로 쿼리의 성능 테스트는 워밍업 된 상태를 가정하고 테스트**하는 편이다.  
간단한 쿼리의 성능 비교 테스트에서는 특별히 영향을 미칠 프로세스나 다른 쿼리가 실행되고 있는지 확인한 후, 쿼리 캐시만 사용하지 않도록 설정하고 테스트를 진행하면 충분하다.

운영체제의 캐시나 MySQL의 버퍼 풀, 키 캐시는 크기가 제한적이라서 쿼리에서 필요로 하는 데이터나 인덱스 페이지보다 크기가 작으면 플러시 작업과 캐시 작업이 반복해서 발생하므로 쿼리를 1번 실행해서 나온 결과를 그대로 신뢰하기 어렵다.  
테스트하려는 쿼리를 번갈아 가면서 6~7번 정도 실행한 후, 처음 몇 번의 결과는 버리고 나머지 결과의 평균 값을 기준으로 비교하는 것이 좋다.
