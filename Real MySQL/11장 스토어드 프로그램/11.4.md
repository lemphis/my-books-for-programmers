# 11.4 스토어드 프로그램의 참고 및 주의사항

## 11.4.1 한글 처리

스토어드 프로그램의 소스 코드에 한글 문자열 값을 사용해야 한다면 스토어드 프로그램을 생성하는 클라이언트 프로그램이 어떤 문자 집합으로 MySQL 서버에 접속되어 있는지가 중요해진다.  
MySQL 클라이언트에서 현재 연결된 커넥션과 데이터베이스 서버가 어떤 문자 집합을 사용하는지는 다음과 같이 MySQL 클라이언트의 세션 변수를 확인해 보면 된다.

```sql
SHOW VARIABLES LIKE 'character%'
```

스토어드 프로그램을 생성하는 데 관여하는 부분은 character_set_connection과 character_set_client 세션 변수 정도다.  
이 세션 변수는 특별히 설정을 해주지 않으면 "latin1"을 기본값으로 가지게 된다.  
"latin1"은 영어권 알파벳을 위한 문자 집합이지, 한글을 포함한 아시아권의 멀티 바이트를 사용하는 언어를 위한 문자 집합은 아니다.

문자 집합을 변경하려면 다음과 같이 문자 집합 관련 변수를 변경해도 되고, 가장 아랫줄처럼 하나의 설정 명령으로 세 개의 변수를 한꺼번에 똑같은 문자 집합으로 변경할 수도 있다.

```sql
SET character_set_connection = 'utf8';
SET character_set_results = 'utf8';
SET character_set_client = 'utf8';

SET names 'utf8';
```

일반적인 MySQL 클라이언트 도구는 한동안 사용하지 않으면 커넥션이 끊어진 상태로 남아 있다가 사용자가 쿼리를 실행하면 그 순간에 다시 커넥션을 생성한다.  
하지만 SET NAMES 'utf8' 명령은 이렇게 재접속하는 경우에는 효과가 없어진다.  
만약 새로 접속돼도 설정한 문자 집합을 그대로 유지하려면 SET NAMES 명령보다는 "CHARSET utf8'과 같은 명령을 사용하는 것도 좋다.  
하지만 이 명령도 MySQL 클라이언트가 완전히 종료됐다가 다시 접속하면 그 설정이 다시 초기화될 것이다.

## 11.4.2 스토어드 프로그램과 세션 변수

스토어드 프로그램에서는 DECLARE 명령을 이용해 스토어드 프로그램의 로컬 변수를 지정할 수 있다.  
또한 스토어드 프로그램 내에서는 "@"로 시작하는 사용자 변수를 사용할 수도 있다.  
DECLARE로 스토어드 프로그램의 변수를 정의할 때는 정확한 타입과 길이를 명시해야 하지만 사용자 변수는 이런 제약이 없다.  
그래서 스토어드 프로그램에서는 로컬 변수는 전혀 사용하지 않고 사용자 변수만 사용할 때도 있다.  
사용자 변수는 타입을 지정하지 않기 때문에 데이터 타입에 대해 안전하지 않고, 영향을 미치는 범위가 넓기 때문에 그만큼 느리게 처리된다.  
또한 사용자 변수는 적어도 그 커넥션에서는 계속 그 값을 유지한 채 남아 있기 때문에 항상 사용하기 전에 적절한 값으로 초기화하고 사용해야 한다.

## 11.4.3 스토어드 프로시저와 재귀 호출(Recursive call)

스토어드 프로그램에서도 재귀 호출을 사용할 수 있는데, 스토어드 프로시저에서만 사용 가능하며 스토어드 함수와 트리거, 이벤트에서는 사용할 수 없다.

MySQL에서는 재귀 호출이 무한 반복되거나 너무 많이 반복해서 호출될 때 스택 메모리 공간 부족 오류 발생을 막기 위해 최대 몇 번까지 재귀 호출을 허용할지를 설정하는 max_sp_recursion_depth라는 시스템 변수가 있다.  
max_sp_recursion_depth 값은 기본적으로 0으로 설정되어 있으므로 이 설정값을 변경하지 않으면 MySQL의 스토어드 프로시저에서 재귀 호출을 사용할 수 없다.

## 11.4.4 중첩된 커서 사용

일반적으로는 하나의 커서를 열고 사용이 끝나면 닫고 다시 새로운 커서를 열어서 사용하는 형태도 많이 사용하지만 중첩된 루프 안에서 두 개의 커서를 동시에 열어서 사용해야 할 때도 있다.  
기본적으로 이렇게 두 개의 커서를 동시에 열어서 사용할 때는 특별히 예외 핸들링 부분에 주의해야 한다.
