# 15.1 문자열(CHAR와 VARCHAR)

문자열 칼럼을 사용할 때는 우선 CHAR 타입과 VARCHAR 타입 중 어떤 타입을 사용할지 결정해야 한다.

## 15.1.1 저장 공간

CHAR와 VARCHAR의 가장 큰 공통점은 문자열을 저장할 수 있는 데이터 타입이라는 점이고, 가장 큰 차이는 고정 길이인지 가변 길이인지에 대한 여부다.

- 고정 길이
  - 실제 입력되는 칼럼 값의 길이에 따라 사용하는 저장 공간의 크기가 변하지 않음
  - 실제 저장된 값의 유효 크기가 얼마인지 별도로 저장할 필요가 없으므로 추가 공간이 필요하지 않음
- 가변 길이
  - 최대로 저장할 수 있는 값의 길이는 제한되어 있지만, 그 이하 크기의 값이 저장되면 그만큼 저장 공간이 줄어듦
  - 저장된 값의 유효 크기가 얼마인지를 별도로 저장해야 하기 때문에 1~2바이트의 저장 공간이 추가로 더 필요함

VARCHAR 타입의 길이가 255바이트 이하이면 1바이트만 사용하고 타입의 길이가 256바이트 이상으로 설정되면 2바이트를 길이를 저장하는 데 사용된다.  
VARCHAR 타입의 최대 길이는 2바이트로 표현할 수 있는 이상은 사용할 수 없다.  
즉, VARCHAR 타입의 최대 길이는 65536 이상으로 설정할 수 없다.

문자열 값의 길이가 항상 일정하다면 CHAR를 사용하고, 가변적이라면 VARCHAR를 사용하는 것이 일반적이다.  
실제 문자열 값의 길이가 정적이냐 가변적이냐만으로 CHAR와 VARCHAR 타입을 결정하는 것은 적절하지 않다.  
CHAR 타입과 VARCHAR 타입을 결정할 때 중요한 판단 기준은 다음과 같다.

- 저장되는 문자열의 길이가 대개 비슷한가?
- 칼럼의 값이 자주 변경되는가?

기존에 저장되어 있는 문자열보다 길이가 더 긴 값으로 변경하려고 할 때 CHAR 타입은 문제 되지 않지만, **VARCHAR 타입은 레코드 자체를 다른 공간으로 옮기거나(Row migration) 칼럼 값의 나머지 부분을 다른 공간에 저장(Row chaining)해야 한다.**  
레코드의 이동이나 분리는 CHAR 타입으로 인해 발생하는 2~3바이트 공간 낭비보다 더 큰 공간이나 자원을 낭비하게 만든다.

MySQL에서 CHAR나 VARCHAR 뒤에 지정하는 숫자는 그 칼럼의 바이트 크기가 아니라 문자의 수를 의미한다.  
즉, CHAR(10) 또는 VARCHAR(10)으로 칼럼을 정의하면, 이 칼럼은 10바이트를 저장할 수 있는 공간이 아니라 10글자(문자)를 저장할 수 있는 공간을 의미한다.

## 15.1.2 비교 방식

MySQL에서 문자열 칼럼을 비교하는 방식은 CHAR와 VARCHAR가 거의 같다.  
CHAR 타입의 칼럼을 SELECT를 실행했을 때 다른 DBMS처럼 사용되지 않는 공간에 공백 문자가 채워져서 나오지 않는다.  
그리고 MySQL에서는 CHAR 타입이나 VARCHAR 타입을 비교할 때 칼럼 값의 뒤쪽에 붙은 공백 문자는 모두 제거하고 비교를 수행한다.

## 15.1.3 문자 집합(캐릭터 셋)

MySQL 서버에서 각 테이블의 칼럼은 모두 서로 다른 문자 집합을 사용해 문자열 값을 저장할 수 있다.  
문자 집합은 문자열을 저장하는 CHAR와 VARCHAR, TEXT 타입의 칼럼에만 설정할 수 있다.  
MySQL에서 최종적으로는 칼럼 단위로 문자 집합을 관리하지만 관리의 편의를 위해 MySQL 서버와 DB, 테이블 단위로 기본 문자 집합을 설정할 수 있게 기능을 제공한다.

MySQL 서버에서 사용 가능한 문자 집합은 "SHOW CHARACTER SET" 명령으로 확인해 볼 수 있다.  
한국에서 MySQL을 사용한다면 대부분 Latin 계열의 문자 집합(latin1, latin2, latin7)과 euckr, utf8만 사용하면 충분하다.

- latin
  - 알파벳이나 숫자, 키보드의 특수 문자로만 구성된 문자열만 저장해도 될 때 저장 공간을 절약하면서 사용할 수 있는 문자 집합
  - 대부분 해시 값이나 16진수로 구성된 헥사 스트링 또는 단순한 코드 값을 저장하는 용도로 사용
- euckr
  - 한국어 전용으로 사용되는 문자 집합
  - 모든 글자는 1~2바이트 사용
- utf8
  - 다국어 문자를 포함할 수 있는 칼럼에 적합
  - 디스크에 저장할 때는 한 글자를 저장하기 위해 1~3바이트까지 사용
  - **메모리에 기록될 경우(MEMORY 테이블이나 정렬 버퍼 등과 같은 용도)에는 무조건 3바이트로 공간 할당**

MySQL에서는 문자 집합을 설정하는 시스템 변수가 여러 가지가 있다.  
다음은 MySQL에서 설정 가능한 문자 집합 관련 변수들이다.

- character_set_system
  - MySQL 서버가 식별자(Identifier, 테이블이나 칼럼명 등)를 저장할 때 사용하는 문자 집합
  - 항상 utf8로 설정되며, 사용자가 설정하거나 변경할 필요 없음
- character-set-server
  - MySQL 서버의 기본 문자 집합
  - DB나 테이블 또는 칼럼에 아무런 문자 집합이 설정되어 있지 않을 때 이 시스템 변수에 명시된 문자 집합이 기본으로 사용됨
- character_set_database
  - MySQL DB의 기본 문자 집합
  - DB를 생성할 때 아무런 문자 집합이 명시되지 않으면 이 시스템 변수에 명시된 문자 집합이 기본으로 사용됨
  - 만약 이 변수가 정의되지 않으면 character-set-server 설정 변수에 명시된 문자 집합이 기본으로 사용됨
- character_set_filesystem
  - LOAD DATA INFILE ... 또는 SELECT ... INTO OUTFILE 문장을 실행할 때 인자로 지정되는 파일의 이름을 해석할 때 사용되는 문자 집합
  - 데이터 파일의 내용을 읽을 때 사용하는 문자 집합이 아니라 파일의 이름을 찾을 때 사용하는 문자 집합임
  - 각 커넥션에서 임의의 문자 집합으로 변경해서 사용 가능
- character_set_client
  - MySQL 클라이언트에서 보낼 SQL 문장을 인코딩하여 MySQL 서버로 전송할 때 사용되는 문자 집합
  - 각 커넥션에서 임의의 문자 집합으로 변경해서 사용 가능
- character_set_connection
  - MySQL 서버가 클라이언트로부터 전달받은 SQL 문장을 처리할 때 사용되는 문자 집합
  - 각 커넥션에서 임의의 문자 집합으로 변경해서 사용 가능
- character_set_results
  - MySQL 서버가 쿼리의 처리 결과를 클라이언트로 보낼 때 사용되는 문자 집합
  - 각 커넥션에서 임의의 문자 집합으로 변경해서 사용 가능

### 클라이언트로부터 쿼리를 요청받았을 때의 문자 집합 변환

MySQL 서버는 클라이언트로부터 받은 메시지(SQL 문장과 변숫값)가 character_set_client에 지정된 문자 집합으로 인코딩되어 있다고 판단하고, 받은 문자열 데이터를 character_set_connection에 정의된 문자 집합으로 변환한다.  
하지만 SQL 문장에 별도의 문자 집합이 지정된 리터럴(문자열)은 변환 대상에 포함되지 않는다.

SQL 문장에서 별도로 문자 집합을 설정하는 지정자를 "인트로듀서"라고 한다.

### 처리 결과를 클라이언트로 전송할 때의 문자 집합 변환

character_set_connection에 정의된 문자 집합으로 변환해 SQL을 실행한 다음, MySQL 서버는 쿼리의 결과(결과 셋이나 에러 메시지)를 character_set_results 변수에 설정된 문자 집합으로 변환해 클라이언트로 전송한다.  
이때 결과 셋에 포함된 칼럼의 값이나 칼럼명과 같은 메타 데이터도 모두 character_set_results로 인코딩되어 클라이언트로 전송된다.

변환 전의 문자 집합이 변환해야 할 문자 집합과 동일하다면 별도의 문자 집합 변환 작업은 모두 생략한다.  
예를 들어, 쿼리를 MySQL 서버로 전송할 때 character_set_client와 character_set_connection의 문자 집합이 같다면 MySQL 서버가 클라이언트로부터 쿼리 요청을 받아도 문자 집합은 변환하지 않는다.  
결과를 클라이언트로 전송할 때도 character_set_results와 칼럼의 문자 집합이 똑같다면 별도의 변환이 필요하지 않게 된다.  
여기서 문자 집합이라고만 표현했지만 문자 집합은 물론이고 콜레이션까지 포함해서 같은지 다른지를 비교한다.

character_set_client와 character_set_results, character_set_connection이라는 3개의 시스템 설정 변수에 대해서는 클라이언트 프로그램이나 클라이언트 GUI 도구에서 마음대로 변경할 수 있다.  
즉 이 시스템 설정 변수는 모두 세션 변수이면서 동적 변수다.

## 15.1.4 콜레이션(Collation)

콜레이션은 **문자열 칼럼의 값에 대한 비교나 정렬 순서를 위한 규칙**을 의미한다.  
즉 비교나 정렬 작업에서 영문 대소문자를 같은 것으로 처리할지 아니면 더 크거나 작은 것으로 판단할지에 대한 규칙을 정의하는 것이다.

MySQL의 모든 문자열 타입의 칼럼은 독립적인 문자 집합과 콜레이션을 가진다.  
콜레이션이란 문자열 칼럼의 값을 비교하거나 정렬하는 기준이 된다.  
그래서 각 문자열 칼럼의 값을 비교하거나 정렬할 때는 항상 문자 집합뿐 아니라 콜레이션의 일치 여부에 따라 결과가 달라지며, 쿼리의 성능 또한 상당한 영향을 받는다.

문자 집합은 2개 이상의 콜레이션을 가지고 있는데, 하나의 문자 집합에 속한 콜레이션은 다른 문자 집합과 공유해서 사용할 수 없다.  
또한 테이블이나 칼럼에 문자 집합만 지정하면 해당 문자 집합의 디폴트 콜레이션이 해당 칼럼의 콜레이션으로 지정된다.  
반대로 칼럼의 문자 집합은 지정하지 않고 콜레이션만 지정하면, 그 콜레이션이 소속된 문자 집합이 묵시적으로 그 칼럼의 문자 집합으로 사용된다.

콜레이션의 이름은 2개 또는 3개의 파트로 구분되어 있으며, 각 파트는 다음과 같은 의미로 사용된다.

- 3개의 파트로 구성된 콜레이션 이름
  - 첫 번째 파트: 문자 집합 이름
  - 두 번째 파트: 해당 문자 집합의 하위 분류
  - 세 번째 파트: 대문자나 소문자의 구분 여부
    - ci: 대소문자를 구분하지 않는 콜레이션(Case Insensitive)
    - cs: 대소문자를 별도의 문자로 구분하는 콜레이션(Case Sensitive)
- 2개의 파트로 구성된 콜레이션 이름
  - 첫 번째 파트: 문자 집합 이름
  - 두 번째 파트: 항상 "bin"이라는 키워드가 사용됨(이진 데이터를 의미하며, 비교 및 정렬은 실제 문자 데이터의 바이트 값 기준으로 수행)

때로는 WHERE 조건의 검색은 대소문자를 구분하지 않고 실행하되 정렬은 대소문자를 구분해서 해야 할 때도 있는데, 이때는 검색과 정렬 작업 중에서 하나는 인덱스를 이용하는 것을 포기하는 수밖에 없다.  
주로 이때는 칼럼의 콜레이션을 _ci로 만들어 검색은 인덱스를 충분히 이용할 수 있게 해주고 정렬 작업은 인덱스를 사용하지 않는(Using filesort) 형태로 처리하는 것이 일반적이다.

## 15.1.5 문자열 이스케이프 처리

MySQL에서 SQL 문장에 사용하는 문자열은 프로그래밍 언어에서처럼 "\"를 이용해 이스케이프 처리를 해주는 것이 가능하다.  
MySQL에서는 다른 DBMS와 같이 홑따옴표와 쌍따옴표의 경우에는 홑따옴표나 쌍따옴표를 두 번 연속으로 표기해서 이스케이프 처리할 수도 있다.
