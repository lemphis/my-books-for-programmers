# 15.5 TEXT, BLOB

MySQL에서 대량의 데이터를 저장하려면 TEXT나 BLOB 타입을 사용해야 하는데, 이 두 타입은 많은 부분에서 거의 똑같은 설정이나 방식으로 작동한다.  
TEXT 타입과 BLOB 타입의 유일한 차이점은 TEXT 타입은 문자열을 저장하는 대용량 칼럼이라서 문자 집합이나 콜레이션을 가진다는 것이고, BLOB 타입은 이진 데이터 타입이라서 별도의 문자 집합이나 콜레이션을 가지지 않는다는 것이다.  
다음 표와 같이 TEXT와 BLOB 타입 모두 다시 내부적으로 저장 가능한 최대 길이에 따라 4가지 타입으로 구분한다.

| 데이터 타입            | 필요 저장 공간 </br> (L: 저장하고자 하는 데이터의 바이트 수) | 최대 저장 가능한 바이트 수 |
| :--------------------- | :----------------------------------------------------------- | :------------------------- |
| TINYTEXT, TINYBLOB     | L + 1바이트                                                  | 2^8-1 (255)                |
| TEXT, BLOB             | L + 2바이트                                                  | 2^16-1 (65,535)            |
| MEDIUMTEXT, MEDIUMBLOB | L + 3바이트                                                  | 2^32-1 (16,777,215)        |
| LONGTEXT, LONGBLOB     | L + 4바이트                                                  | 2^64-1 (4,294,967,295)     |

LONG이나 LONG VARCHAR라는 타입도 있는데, MEDIUMTEXT의 동의어이므로 특별히 기억할 필요는 없다.  
이진 데이터를 저장하기 위한 데이터 타입과 문자열을 저장하기 위한 데이터 타입은 다음과 같이 고정 길이나 가변 길이 타입이 정확하게 매핑된다.

|             | 고정 길이 | 가변 길이 | 대용량 |
| :---------- | :-------- | :-------- | :----- |
| 문자 데이터 | CHAR      | VARCHAR   | TEXT   |
| 이진 데이터 | BINARY    | VARBINARY | BLOB   |

MySQL의 TEXT 타입은 오라클에서 CLOB라고 하는 대용량 타입과 동일한 역할을 하는 데이터 타입으로, TEXT와 BLOB 칼럼은 똑같이 사용할 때 주의하고 너무 남용해서는 안 된다.
TEXT나 BLOB 타입은 다음과 같은 상황에서 사용하는 것이 좋다.

- 칼럼 하나에 저장되는 문자열이나 이진 값의 길이가 예측할 수 없을 정도로 클 때 TEXT나 BLOB 사용
  - MySQL에서는 레코드의 전체 크기가 64KB를 넘지 않는 한도 내에서는 VARCHAR나 VARBINARY의 길이는 제한이 없기 때문에 용도에 따라서는 4000바이트 이상의 값을 저장하는 칼럼도 VARCHAR나 VARBINARY 타입 이용 가능
- 만약 레코드의 전체 크기가 64KB를 넘어서서 더 큰 칼럼을 추가할 수 없다면 일부 칼럼을 TEXT나 BLOB 타입으로 전환해야 할 수 있음

MySQL에서 인덱스 레코드의 모든 칼럼은 최대 제한 크기(MyISAM은 1000바이트, InnoDB는 767바이트)를 가지고 있다.  
자주 사영되지는 않지만 BLOB나 TEXT 타입의 칼럼에 인덱스를 생성할 때는 칼럼 값의 몇 바이트까지 인덱스를 생성할 것인지를 명시해야 할 때도 있다.  
물론 최대 제한 크기를 넘어서는 인덱스는 생성할 수 없다.  
만약 TEXT 타입의 문자 집합이 utf8이라면 최대 255글자까지만 인덱스로 저장할 수 있고, latin1이라면 767 글자까지 인덱스로 생성할 수 있다.  
또한 BLOB나 TEXT 칼럼으로 정렬을 수행할 때도 칼럼에 저장된 값이 10MB라 하더라도 실제 정렬은 MySQL 서버의 "max_sort_length" 시스템 설정에 명시된 길이까지만 정렬을 수행한다.  
일반적으로 이 설정값은 1024바이트로 설정되어 있는데, 만약 TEXT 타입의 정렬을 더 빠르게 실행하려면 이 값을 더 줄여서 설정하는 것이 좋다.

MySQL에서는 쿼리의 특성에 따라 임시 테이블을 생성해야 할 때도 있다.  
이때 사용되는 임시 테이블은 메모리에 저장될 수도 있고 디스크에 저장될 수도 있다.  
임시 테이블을 메모리에 저장할 때는 MEMORY 스토리지 엔진을 사용하게 된다.  
하지만 MEMORY 스토리지 엔진은 VARCHAR나 VARBINARY와 같은 가변 길이 타입뿐 아니라 TEXT나 BLOB과 같은 타입을 지원하지 않는다.  
따라서 임시 테이블에 TEXT나 BLOB 타입이 필요하다면 이 임시 테이블은 메모리에 생성되지 못하고 디스크를 사용할 수밖에 없다.

만약 SELECT 쿼리를 통해 가져오려는 BLOB이나 TEXT 타입 칼럼의 값이 크지 않거나 일부만 조회해도 될 때가 있다.  
이럴 때는 CAST()나 SUBSTRING() 함수 등을 이용해 강제로 CHAR나 VARCHAR로 변환해서 조회한다면 필요한 임시 테이블이 메모리에 생성되도록 유도할 수 있다.

BLOB이나 TEXT 타입 칼럼 값의 길이에 따라 디스크에 저장하는 방식도 달라질 수 있다.

- InnoDB
  - MySQL 5.0과 이전 버전의 파일 포맷(Antelope 파일 포맷의 COMPACT 레코드 포맷)에서는 BLOB이나 TEXT 칼럼 값의 앞쪽 768바이트는 다른 레코드와 함께 기록하고, 나머지는 별도의 공간(데이터 페이지)에 저장
  - MySQL 5.1 이후 버전에서는 도입된 새로운 파일 포맷(Barracuda 파일 포맷의 DYNAMIC 레코드 포맷)에서는 BLOB이나 TEXT 칼럼의 값 전체를 다른 데이터 페이지에 저장
    - SQL에서 BLOB이나 TEXT 칼럼을 별도로 명시하거나 사용하지 않으면 BLOB이나 TEXT가 저장된 데이터 페이지를 접근하거나 읽지 않으므로 꼭 필요할 때만 BLOB이나 TEXT 칼럼을 SQL에 사용해야 함
- MyISAM
  - 고정(FIXED) 길이 포맷과 가변(DYNAMIC) 길이 포맷을 선택할 수 있음
  - BLOB이나 TEXT, VARCHAR와 같은 가변 길이 칼럼이 있는 테이블에는 고정 길이 포맷을 사용할 수 없음
  - 가변 길이 포맷에서는 BLOB이나 TEXT 칼럼의 데이터는 다른 일반 칼럼과는 다른 데이터 블록에 저장되므로 BLOB이나 TEXT가 아닌 일반 칼럼만 변경하거나 읽는 SQL에서는 BLOB이나 TEXT 칼럼의 데이터에 접근하지 않음

BLOB이나 TEXT 타입의 칼럼이 포함된 테이블에 실행되는 INSERT나 UPDATE 문장 중에서 BLOB이나 TEXT 칼럼을 조작하는 SQL 문장은 매우 길어질 수 있는데, MySQL 서버의 max_allowed_packet 시스템 설정에 정의된 값보다 큰 SQL 문장은 MySQL 서버로 전송되지 못하고 오류가 발생하게 된다.  
만약 대용량 BLOB이나 TEXT 칼럼을 사용하는 쿼리가 있다면 MySQL 서버의 max_allowed_packet 시스템 설정을 필요한 만큼 충분히 늘려 주는 것이 좋다.
