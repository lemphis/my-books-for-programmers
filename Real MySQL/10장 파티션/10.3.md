# 10.3 MySQL 파티션의 종류

다른 DBMS와 마찬가지로 MySQL에서도 다음과 같은 4가지 기본 파티셔닝 기법을 제공하고 있으며, 해시와 키 파티션에 대해서는 리니어(Linear) 파티션과 같은 추가적인 기법도 제공한다.

- 레인지 파티션
- 리스트 파티션
- 해시 파티션
- 키 파티션

## 10.3.1 레인지 파티션

파티션 키의 연속된 범위로 파티션을 정의하는 방법으로, 가장 일반적으로 사용되는 파티션 방법 중 하나다.

### 레인지 파티션의 용도

다음과 같은 성격을 지닌 테이블에서는 레인지 파티션을 사용하는 것이 좋다.

- 날짜를 기반으로 데이터가 누적되고 연도나 월 또는 일 단위로 분석하고 삭제해야 할 때
- 범위 기반으로 데이터를 여러 파티션에 균등하게 나눌 수 있을 때
- 파티션 키 위주로 검색이 자주 실행될 때

### 레인지 파티션 주의사항

레인지 파티션에서 NULL은 어떤 값보다 작은 값으로 간주된다.  
만약 파티션 키에 해당하는 값이 NULL인 레코드가 INSERT 된다면 이 레코드는 파티션 키값이 가장 작은 값으로 설정된 파티션으로 저장된다.

날짜 칼럼의 값으로 파티션을 만들 경우, 다음과 같은 파티션 키를 사용하는 파티셔닝은 피하는 것이 좋다.

- UNIX_TIMESTAMP()를 이용한 변환 식을 파티션 키로 사용
- 날짜를 문자열로 포맷팅한 형태('2023-08-06')의 파티션 키
- YEAR()나 TO_DAYS() 함수 이외의 함수가 사용된 파티션 키

위와 같은 표현식으로 파티션 된 테이블에서는 MySQL의 파티션 프루닝이 정상적으로 작동하지 않을 수도 있다.  
날짜 칼럼에 대해 레인지 파티션을 적용할 경우 파티션 키로 다음 2개의 함수 중 하나를 사용하길 권장한다.

- YEAR(date_column)
- TO_DAYS(date_column)

위의 두 날짜 함수는 MySQL 서버 내부적으로 파티션 프루닝 처리가 최적화되어 있어서 성능상의 문제가 발생하지 않는다.

## 10.3.2 리스트 파티션

리스트 파티션은 레인지 파티션과 많은 부분에서 흡사하게 동작한다.  
둘의 가장 큰 차이는 레인지 파티션은 파티션 키값의 연속된 값의 범위로 파티션을 구성할 수 있지만 리스트 파티션은 파티션 값 하나하나를 리스트로 나열해야 한다는 점이다.

### 리스트 파티션의 용도

테이블이 다음과 같은 특성을 지닐 때는 리스트 파티션을 사용하는 것이 좋다.  
마지막 항목은 모든 파티 션에 공통적인 사항이지만 레인지나 리스트 파티션에 더 필요한 사항이다.

- 파티션 키값이 코드 값이나 카테고리와 같이 고정적일 때
- 키값이 연속되지 않고 정렬 순서와 관계없이 파티션을 해야 할 때
- 파티션 키값을 기준으로 레코드의 건수가 균일하고, 검색 조건에 파티션 키가 자주 사용될 때

### 리스트 파티션 주의사항

- 명시되지 않은 나머지 값을 저장하는 MAXVALUE 파티션을 정의할 수 없음
- 레인지 파티션과는 달리 NULL을 저장하는 파티션을 별도로 생성 가능

## 10.3.3 해시 파티션

해시 파티션은 MySQL에서 정의한 해시 함수에 의해 레코드가 저장될 파티션을 결정하는 방법이다.  
MySQL에서 정의한 해시 함수는 파티션 표현식의 결괏값을 파티션의 개수로 나눈 나머지로 저장될 파티션을 결정하는 방식이다.  
해시 파티션의 파티션 키는 항상 정수 타입의 칼럼이거나 정수를 반환하는 표현식만 사용될 수 있다.  
해시 파티션에서 파티션의 개수는 레코드를 각 파티션에 할당하는 알고리즘과 연관되기 때문에 파티션을 추가하거나 삭제하는 작업에는 테이블 전체적으로 레코드를 재분배하는 작업이 필요하다.

### 해시 파티션의 용도

해시 파티션은 다음과 같은 특성을 지닌 테이블에 적합하다.

- 레인지 파티션이나 리스트 파티션으로 데이터를 균등하게 나누는 것이 어려울 때
- 테이블의 모든 레코드가 비슷한 사용 빈도를 보이지만 테이블이 너무 커서 파티션을 적용해야 할 때

### 해시 파티션 주의사항

- 특정 파티션만 DROP 하는 것은 불가능
- 새로운 파티션을 추가하는 작업은 단순히 파티션만 새로 추가하는 것이 아니라 기존의 모든 데이터의 재배치 작업이 필요함
- 해시 파티션은 레인지 파티션이나 리스트 파티션과는 상당히 다른 방식으로 관리하기 때문에 해시 파티션이 용도에 적합한 해결책인지 확인 필요
- 일반적으로 사용자에게 익숙한 파티션의 조작이나 특성은 대부분 리스트 파티션이나 레인지 파티션에 제한적인 것들이 많음

## 10.3.4 키 파티션

키 파티션은 해시 파티션과 사용법과 특성이 거의 같다.  
해시 파티션은 해시 값을 계산하는 방법을 파티션 키나 표현식에 사용자가 명시하지만 키 파티션은 해시 값의 계산도 MySQL 서버가 수행한다.  
키 파티션에는 정수 타입이나 정숫값을 반환하는 표현식뿐 아니라 거의 대부분의 데이터 타입에 대해 파티션 키를 적용할 수 있다.  
MySQL 서버는 선정된 파티션 키의 값을 MD5() 함수를 이용해 해시 값을 계산하고, 그 값을 MOD 연산해서 데이터를 각 파티션에 분배한다.

## 10.3.5 리니어 해시 파티션/리니어 키 파티션

해시 파티션이나 키 파티션에서 새로운 파티션을 추가하거나 파티션을 통합해서 개수를 줄일 때 테이블의 전체 파티션에 저장된 레코드의 재분배 작업이 수행되는 단점을 최소화하기 위해 리니어(Linear) 해시 파티션/리니어 키 파티션 알고리즘이 고안되었다.  
리니어 해시 파티션/리니어 키 파티션은 각 레코드 분배를 위해 "Power-of-two(2의 승수)" 알고리즘을 이용하며, 이 알고리즘은 파티션의 추가나 통합 시 다른 파티션에 미치는 영향을 최소화할 수 있게 해준다.

### 리니어 해시 파티션/리니어 키 파티션과 관련된 주의사항

파티션을 추가하거나 통합할 때 작업의 범위를 최소화할 수는 있지만 각 파티션이 가지는 레코드의 건수는 일반 해시 파티션이나 키 파티션보다는 덜 균등해질 수 있다.  
해시 파티션이나 키 파티션으로 파티션 된 테이블에 대해 새로운 파티션을 추가하거나 삭제해야 할 요건이 많다면 리니어 해시 파티션 또는 리니어 키 파티션을 적용하는 것이 좋다.  
만약 파티션을 조정할 필요가 거의 없다면 일반 해시 파티션이나 키 파티션을 사용하는 것이 좋다.

## 10.3.6 서브 파티션

다른 상용 DBMS와 같이 MySQL 또한 서브 파티션 기능을 제공한다.  
서비스의 요건에 따라 기간 단위로 레인지 파티션을 생성하고, 각 레인지 파티션 내에서 다시 지역별로 리스트 서브 파티션을 구성하는 형태의 파티션이 가능한 것이다.

## 10.3.7 파티션 테이블의 실행 계획

파티션 테이블에 쿼리가 실행될 때 테이블의 모든 파티션을 읽는지 아니면 일부의 파티션만 읽는지는 성능에 아주 큰 영향을 미친다.  
쿼리의 성능은 얼마나 많은 파티션을 프루닝할 수 있는지가 관건이다.  
옵티마이저가 수립하는 실행 계획에서 어떤 파티션이 제외되고 어떤 파티션만을 접근하는지는 쿼리의 실행 계획으로 확인할 수 있다.

## 10.3.8 파티션 테이블 관련 벤치마킹

### 테이블 크기

KEY 파티션의 경우 일반 테이블과 거의 비슷했지만 레인지 파티션의 경우 좀 더 크기가 크다.  
파티션을 이용한다고 해서 디스크의 공간적인 장점은 없다는 것을 알 수 있다.  
디스크에서 차지하는 공간이 크다는 것은 InnoDB 버퍼 풀 메모리로 읽어들여야 할 데이터가 많다는 것과 동일한 의미다.

### INSERT 성능 테스트

20개 미만의 파티션으로 구성된 테이블에서 대략 1,200만 건의 레코드를 INSERT 하는 테스트를 실행한 결과, 레인지 파티션이 일반 테이블보다 35% 정도 더 빠르다는 결과를 확인할 수 있었다.  
하지만 파티션이 많은 테이블에서는 INSERT나 UPDATE, DELETE 등의 쿼리 수행 시 모든 파티션에 락을 거는 작업 때문에 더 느려질 수 있다는 점에 주의한다.

### SELECT 성능 테스트

파티션 된 테이블과 파티션 되지 않은 테이블의 SELECT 성능은 거의 차이가 없다.

## 10.3.9 파티션 기능에 대한 결론

MySQL의 파티션은 SELECT 쿼리의 성능에는 그다지 큰 도움을 주지 못했으며, 쓰기 성능에는 어느 정도 도움 되는 것으로 보인다.

만약 날짜 칼럼을 이용해 레인지 파티션을 사용할 수 있고, 읽기나 쓰기 작업을 일부 파티션으로 모을 수 있다면 테이블의 크기에 관계없이 항상 파티션을 적용하는 것이 쓰기 및 읽기, 관리 작업까지 상당히 도움 될 것이다.  
하지만 해시나 키 파티션을 사용해야 하는 상황이라면 무조건 파티션을 적용하기보다는 쓰기 성능이 현저히 떨어졌을 경우에 쓰기 성능의 개선을 위해 파티션 적용을 고려해 보는 것이 좋다.
