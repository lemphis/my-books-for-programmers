# 3.1 MySQL 아키텍처

## 3.1.1 MySQL의 전체 구조

MySQL 서버는 크게 `MySQL 엔진`과 `스토리지 엔진`으로 구분해서 볼 수 있다.  

- MySQL 엔진
  - 요청된 SQL 문장을 분석하거나 최적화하는 등 DBMS의 두뇌에 해당하는 처리를 수행
  - 커넥션 핸들러, SQL 파서 및 전처리기, 옵티마이저가 중심을 이룸
  - 성능 향상을 위한 MyISAM의 키 캐시, InnoDB의 버퍼 풀과 같은 보조 저장소 기능이 포함되어 있음
- 스토리지 엔진
  - 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분을 담당
- 핸들러 API
  - MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어야 할 때, 각 스토리지 엔진에게 쓰기 또는 읽기를 요청하는 것을 핸들러 요청이라고 함
  - 핸들러 요청 시 사용되는 API를 핸들러 API라고 함

## 3.1.2 MySQL 스레딩 구조

MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동하며, 크게 포그라운드(Foreground) 스레드와 백그라운드(Background) 스레드로 구분할 수 있다.

- 포그라운드 스레드 (클라이언트 스레드)
  - 최소한 MySQL 서버에 접속된 클라이언트의 수만큼 존재하며, 주로 **각 클라이언트 사용자가 요청하는 쿼리 문장을 처리**하는 역할
  - 클라이언트 사용자가 작업을 마치고 커넥션을 종료하면, 해당 커넥션을 담당하던 스레드는 스레드 캐시(Thread pool)로 되돌아감
  - 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져오며, 버퍼나 캐시에 없는 경우 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어서 작업 처리
- 백그라운드 스레드
  - 다양한 작업을 하는 백그라운드 스레드들과 이러한 모든 스레드를 총괄하는 메인 스레드가 있음
    - 인서트 버퍼(Insert buffer)를 병합
    - 로그를 디스크로 기록하는 스레드
    - InnoDB 버퍼 풀의 데이터를 디스크에 기록
    - 데이터를 버퍼로 읽어들이는 스레드
    - 기타 여러 가지 잠금이나 데드락을 모니터링
  - 데이터를 읽는 작업은 주로 클라이언트 스레드에서 처리되기 때문에 읽기 스레드는 많이 설정할 필요 없음
  - 데이터를 쓰는 작업은 아주 많은 작업을 백그라운드 스레드로 처리하기 때문에 일반적인 내장 디스크를 사용할 때는 2~4 정도, DAS나 SAN과 같은 스토리지를 사용할 때는 4개 이상으로 설정하는 것이 좋음
