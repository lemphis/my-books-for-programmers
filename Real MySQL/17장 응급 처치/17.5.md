# 17.5 복제가 멈추었을 때

복제가 구축된 MySQL 서버에서 쿼리나 시스템적인 오류로 인해 슬레이브의 복제가 진행되지 않고 멈추는 문제가 자주 발생할 수 있다.  
만약 서비스용으로 사용하지 않는 슬레이브라면 하루 이틀 정도(마스터의 바이너리 로그가 남아 있는 동안)는 특별히 문제 되지 않을 것이다.  
하지만 슬레이브 MySQL 서버를 서비스용 애플리케이션에서 사용한다면 사용자에게 잘못된 결과를 보여 주게 되므로 큰 문제가 될 것이다.

슬레이브 MySQL은 마스터 데이터와의 동기화를 위해 "SQL 스레드"와 "IO 스레드"라는 2개의 스레드를 사용하는데, 이 두 스레드의 상태가 모두 정상일 때만 복제가 정상적으로 진행된다.  
만약 복제가 되지 않는다면 이 두 스레드 중 하나가 오류로 인해 복제가 멈춰 있기 때문일 것이다.  
만약 복제가 진행되지 않고 멈춰 있다면 이 두 스레드 가운데 어떤 스레드가 멈춰 있는지에 따라 원인과 대처 방법이 달라진다.

우선 슬레이브 MySQL에 로그인해서 "show slave status"라는 명령으로 슬레이브 MySQL 서버의 복제 상태를 확인해야 한다.  
이 명령의 결과로 복제와 관련된 여러 가지 정보를 확인할 수 있는데, 그중에서 가장 중요한 것은 "Slave_IO_Running"과 "Slave_SQL_Running" 스레드의 상태 값이다.  
이 값이 "Yes"이면 해당 스레드가 정상적으로 작동하고 있음을 의미하고, 둘 중 하나라도 상태가 "No"라면 복제가 멈춰 있는 상태를 의미한다.  
또한 "show slave status" 명령의 결과에서 "Seconds_Behind_Master"라는 상태 값은 현재 슬레이브의 데이터가 마스터보다 얼마나(몇 초나) 지연되어 있는지 보여준다.  
슬레이브 MySQL 서버에 특별한 오류가 없더라도 마스터에서 너무 많은 트랜잭션이 실행되거나 무거운 쿼리가 실행되면 복제 지연이 발생해 "Seconds_Behind_Master" 값은 0보다 큰 값을 표시할 수도 있다.

- IO 스레드가 멈췄을 때
  - IO 스레드는 마스터 MySQL로부터 바이너리 로그를 가져오는 역할 수행
  - 이 스레드의 상태가 "No"일 때는 슬레이브 MySQL이 마스터 MySQL 서버에 접속하지 못하거나 로그인을 못하고 있음을 의미함
  - 이때는 네트워크가 정상적인지, 마스터 MySQL 서버가 정상적으로 작동하고 있는지, 복제용 MySQL 계정이 사용 가능한지 확인해 보는 것이 좋음
- SQL 스레드가 멈췄을 때
  - SQL 스레드는 IO 스레드가 가져온 바이너리 로그를 슬레이브 MySQL 서버에서 재실행(Replay)하는 역할 수행
  - 이때 재실행하는 쿼리 중에서 오류가 발생한다면 SQL 스레드는 더 진행되지 않고 멈춰 있게 됨

SQL 스레드가 재실행하는 쿼리에서 무슨 문제가 있었는지는 "Last_Error" 칼럼에 표시되는데, 일반적으로 문제의 쿼리도 같이 표시되므로 쉽게 원인을 찾을 수 있다.  
그리고 "Last_Errno"에는 그 에러의 에러 번호를 기록하고 있다.  
이 에러의 종류에 따라 적절한 조치가 필요하다.

- "Lock wait timeout exceeded"
  - 단순히 복제 슬레이브를 재시작(STOP SLAVE & START SLAVE)하는 것만으로 대부분 해결됨
- AUTO_INCREMENT가 아닌 프라이머리 키의 "Duplicate Key error"로 인한 오류
  - 이미 슬레이브에 저장된 데이터를 또 저장하려는 것일 가능성이 높음
  - 이때는 프라이머리 키값을 기준으로 기존 테이블의 레코드와 복제 도중 에러가 발생한 쿼리의 각 칼럼 값을 비교해서 그냥 버릴지 기존의 레코드를 SQL의 칼럼 값으로 업데이트할지 결정하면 됨
  - 레코드의 복구 처리가 완료되면 슬레이브 MySQL이 복제 도중 에러를 발생시킨 쿼리는 무시하고 바이너리 로그의 다음 쿼리부터 계속 복제를 수행하게 해주면 됨
  - "sql_slave_skip_counter" 시스템 변수는 슬레이브 MySQL 서버가 바이너리 로그에서 몇 개의 쿼리를 무시하고 복제를 계속 진행할지를 결정함
- AUTO_INCREMENT 프라이머리 키나 유니크 키의 "Duplicate Key error"로 인한 오류
  - AUTO_INCREMENT 칼럼은 쿼리가 실행될 때마다 증가되는 값이므로 마스터 MySQL과 슬레이브 MySQL에서 동기화되지 못해서 발생한 에러일 가능성이 높음
  - SQL 스레드에서 실행하려고 했던 SQL 문장의 각 칼럼을 이용해 기존 테이블에 똑같은 칼럼 값을 가지는 레코드가 있는지 찾아보고, AUTO_INCREMENT 프라이머리 키나 유니크 키로도 검색해 똑같은 레코드인지 비교해 봐야 함
  - 위의 경우를 고려해서 슬레이브 MySQL 서버의 테이블에 적절히 INSERT하거나 UPDATE하면 됨
  - 적용이 완료되면 "sql_slave_skip_counter"를 1로 설정해서 바이너리 로그의 쿼리 1개를 무시하고 복제가 다음으로 진행되게 해주면 됨
- 이 밖의 원인으로 에러가 발생하고 SQL 스레드가 다음으로 진행하지 못하고 있다면 적절히 에러의 원인을 파악하고 해당 쿼리를 무시해도 될지 결정해야 함
