# 14.2 물리 모델링

물리 모델링에서는 논리 모델링을 통해 나온 산출물을 RDBMS의 특성에 맞게 변환하는 작업을 수행한다.  
대표적인 작업 내용은 다음과 같다.

- 논리 모델에서 신경 쓰지 않았던 M:M 관계와 같이 RDBMS에서 구현할 수 없는 구조를 해소하는 작업
- 프라이머리 키의 칼럼 순서 선정
- 칼럼의 이름 부여
- 칼럼의 데이터 타입 선정
- 조회 성능을 위한 반정규화

## 14.2.1 프라이머리 키 선택

논리 모델링에서 선정한 식별자가 항상 물리 모델의 프라이머리 키가 되는 것은 아니다.  
논리 모델에서는 식별자를 구성하는 각 속성의 순서가 크게 관심 대상이 아니지만 물리 모델에서는 프라이머리 키를 구성하는 칼럼의 순서가 매우 중요하다.

테이블의 프라이머리 키를 복합 칼럼으로 구성할 때는 너무 많은 칼럼이 프라이머리 키로 참여하지 않게 적절히 끊어줄 필요가 있다.  
자식 테이블 중에서도 액션(관계)을 많이 가지는 중요 테이블에서 부모와의 프라이머리 키 상속을 끊고, 새로운 프라이머리 키를 갖게 해주는 것이 좋다.  
주로 이렇게 부모와의 프라이머리 키 상속을 끊게 되면 시퀀스나 자동 증가 칼럼(Auto-Increment)과 같은 인조 키를 부여하는 방법이 사용된다.

## 14.2.2 데이터 타입 선정

물리 모델링에서 칼럼의 데이터 타입은 가능한 한 최소 단위의 타입을 부여해야 한다.  
이유는 [여기](../06장%20실행%20계획/6.3.md#임시-테이블-관련-주의사항)에 자세히 언급되어 있다.

테이블의 레코드 건수가 많지 않다면 사실 어떤 칼럼이 프라이머리 키로 선정되고, 각 칼럼의 타입이 어떻게 설정되든 큰 차이가 없다.  
하지만 레코드의 건수가 많아지면 데이터 타입을 한 바이트라도 크게 설정하면 많은 차이를 만들어 낸다.

### 데이터의 타입

어떤 데이터를 관리하기 위해 사용할 수 있는 데이터 타입은 여러 가지가 있을 수 있다.  
만약 각 데이터 타입별로 차지하는 공간이나 성격을 잘 모른다면 저장하려는 데이터 성격별로 그대로 타입을 선정하는 것이 가장 좋다.

문제는 최적의 타입이 명확하지 않고 문자와 숫자 또는 문자와 이진 데이터, 그리고 숫자와 이진 데이터의 중간쯤에 위치한 데이터의 저장 공간을 어떤 타입으로 선정할 것인지다.  
이런 경우 편의성과 성능, 레코드 건수 등을 따져서 적절한 방법을 선택해야 한다.  
어떤 선택을 하든 장단점이 있게 마련인데, 업무적인 용도를 분석해 그에 맞게 장단점을 조율한 후에 선택해야 한다.

### 칼럼의 길이

문자열에 대해 CHAR나 VARCHAR로 타입을 선정했다면 길이는 얼마로 설정할 것인지, 또는 숫자 타입을 사용하기로 결정했다면 TINYINT를 사용할 것인지 아니면 BIGINT를 사용할 것인지를 결정해야 한다.

항상 우리는 칼럼에 저장될 데이터의 최대 길이만을 먼저 생각한다.  
하지만 이러한 판단은 별로 중요하지 않을 때가 많다.  
우리가 관리하는 데이터가 어떤 특성을 가지느냐에 따라 칼럼의 길이를 결정해야 한다.

### 문자 집합 (캐릭터 셋)

문자열 타입에서는 칼럼에 저장되는 문자열이 어떤 문자 집합을 가지는지도 상당히 중요한 문제다.  
문자 집합에 따라 저장 공간의 길이가 두세 배씩 늘어날 수도 있고, 정렬이나 검색 규칙도 바뀔 수 있다.

기본적으로 자국의 언어를 위해 UTF-8이나 euckr을 기본으로 채택하고, 코드나 16진수 해시 값과 같이 알파벳과 숫자로만 구성된 문자열은 Latin1으로 데이터 타입을 선정하는 것도 나쁘지 않다.  
물론 여러 문자 집합 사용으로 인해 혼동이 예상된다면, 하나의 문자 집합만을 선택하는 것이 좋다.

최적의 데이터 타입을 선정하고 칼럼의 길이를 줄이고 최적의 문자 집합을 선정하는 노력들이 항상 눈에 보이는 성능 향상으로 연결되지는 않는다.  
하지만 데이터베이스의 성능은 이런 작은 것들이 모여서 최종 성능으로 연결된다는 사실을 기억해야 한다.

### NULL과 NOT NULL

MySQL에서 NULL이 스토리지 엔진별로 저장되는 방식은 다음과 같다.

- MyISAM 스토리지 엔진
  - NULL을 저장하든 NULL을 대체해서 빈 문자열을 저장하든 사용하는 디스크 공간의 차이 없음
- InnoDB 스토리지 엔진
  - 디스크 공간을 전혀 사용하지 않음

MySQL의 InnoDBsk MyISAM 스토리지 엔진 모두 NULL을 인덱스에 포함하므로 NULL로 검색되는 조건은 레인지 스캔이 가능하다.

### 도메인

일관되지 않은 데이터 타입의 사용을 막기 위해 전사적으로 사용하는 데이터의 성격을 적절한 수준으로 분류해 도메인이라는 개념으로 그룹핑하고 DBMS의 데이터 타입을 부여한다.  
데이터 모델링 단계에서는 각 칼럼의 타입을 선정하는 것이 아니라 칼럼에 도메인을 매핑하는 것이다.  
이렇게 함으로써 하나의 프로그램뿐 아니라 한 회사의 모든 서비스나 애플리케이션에서 사용되는 데이터베이스의 칼럼 타입을 일관성 있게 통일해서 사용할 수 있다.

## 14.2.3 반정규화

모델의 정규화는 최대한 중복되는 칼럼을 제거하므로 INSERT나 UPDATE와 같은 데이터 변경 작업에 최적화된 모델을 만들어 낸다.  
하지만 모델을 정규화할수록 SELECT 쿼리에서 필요한 테이블의 수뿐만 아니라 GROUP BY나 쿼리 자체의 개수도 증가한다.  
GROUP BY나 COUNT(*)와 같이 많은 레코드를 대상으로 하는 작업을 빠르게 조회하기 위해 미리 건수를 집계해서 별도의 테이블이나 칼럼으로 저장해두는 것을 반정규화라고 한다.
