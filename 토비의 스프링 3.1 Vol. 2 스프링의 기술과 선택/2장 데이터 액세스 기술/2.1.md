# 2.1 공통 개념

## 2.1.1 DAO 패턴

데이터 액세스 계층은 DAO 패턴이라 불리는 방식으로 분리하는 것이 원칙이다.  
DAO 패턴은 **DTO 또는 도메인 오브젝트만을 사용하는 인터페이스를 통해 데이터 액세스 기술을 외부에 노출하지 않도록 만드는 것**이다.  
따라서 DAO는 구현 기술에 대한 정보를 외부에 공개해서는 안 된다.  
이를 통해 DAO를 사용하는 코드에 영향을 주지 않고 데이터 액세스 기술을 변경하거나 하나 이상의 데이터 액세스 기술을 혼합해서 사용할 수 있게 해준다.  
가장 중요한 점은 **DAO를 이용하는 서비스 계층의 코드를 기술이나 환경에 종속되지 않는 순수한 POJO로 개발할 수 있다는 것**이다.  
DAO 인터페이스는 기술과 상관없는 단순한 DTO나 도메인 모델만을 사용하기 때문에 언제든지 목 오브젝트 같은 테스트 대역 오브젝트로 대체해서 단위 테스트를 작성할 수 있다.

### DAO 인터페이스와 DI

DAO와 인터페이스는 다음과 같이 만들어야 한다.

- 인터페이스를 이용해 접근하고 DI 되도록 만들어야 함
- 구체적인 데이터 액세스 기술과 관련된 어떤 API나 정보도 노출하지 않아야 함
- DAO를 사용하는 서비스 계층 코드에서 의미 있는 메서드만 인터페이스로 공개해야 함
- 특정 데이터 액세스 기술에서만 의미 있는 DAO 메서드의 이름은 피해야 함(좀 더 일반적인 add(), update()와 같은 이름 선택)

### 예외 처리

데이터 액세스 중에 발생하는 예외는 대부분 복구할 수 없는 예외이기 때문에 DAO 밖으로 던져질 때는 런타임 예외여야 한다.  
또한 DAO 메서드 선언부에 throws SQLException과 같은 내부 기술을 드러내는 예외를 직접 노출해선 안 된다.

스프링은 특정 기술이나 DB의 종류에 상관없이 일관된 의미를 가지는 데이터 예외 추상화를 제공하고, 각 기술과 DB에서 발생하는 예외를 스프링의 데이터 예외로 변환해 주는 변환 서비스를 제공한다.
JdbcTemplate과 같은 템플릿/콜백 기능을 사용하면 변환 서비스가 자동으로 적용된다.  
데이터 액세스 기술의 API를 직접 사용할 때는 스프링에 내장된, AOP를 이용해 예외를 전환해 주는 기능을 사용하면 된다.

최신 데이터 액세스 기술은 JDBC와는 다르게 런타임 예외를 사용한다.  
기술에 독립적인 추상 예외로 전환하고 일관된 예외 복구 기능을 적용할 필요가 없다면 굳이 스프링의 예외 변환 서비스를 사용하지 않아도 된다.

## 2.1.2 템플릿과 API

데이터 액세스 기술을 사용하는 코드는 대부분 try/catch/finally와 판에 박힌 반복되는 코드로 작성되기 쉽다.  
데이터 액세스 기술은 외부의 리소스와 연동하기 때문에 다양한 예외 상황이 발생할 수 있다.  
이런 예외 상황에서 서버의 제한된 리소스에 누수가 발생하지 않도록 예외 상황에서도 사용한 리소스를 적절히 반환해 주는 코드가 반드시 필요하다.  
이 때문에 코드가 길고 지저분해지기 쉽다.

스프링은 DI의 응용 패턴인 템플릿/콜백 패턴을 이용해 이런 판에 박힌 코드를 피하고 꼭 필요한 바뀌는 내용만을 담을 수 있도록 데이터 액세스 기술을 위한 템플릿을 제공한다.

## 2.1.3 DataSource

JDBC를 통해 DB를 사용하려면 Connection 타입의 DB 연결 오브젝트가 필요하다.  
Connection은 모든 데이터 액세스 기술에서 사용되는 필수 리소스다.  
애플리케이션 서버와 DB 사이의 실제 커넥션을 매번 새롭게 만드는 건 비효율적이고 성능을 떨어뜨리기 때문에 보통 미리 정해진 개수만큼의 DB 커넥션을 풀(pool)에 준비해두고, 애플리케이션이 요청할 때마다 풀에서 꺼내 하나씩 할당해 주고 다시 돌려받아서 풀에 넣는 식의 풀링 기법을 이용한다.

스프링에서는 DataSource를 하나의 독립된 빈으로 등록하도록 강력하게 권장한다.  
스프링은 주요 데이터 액세스 기술이 자체적인 DataSource 생성 방식 대신 스프링 빈으로 등록된 DataSource를 사용하는 데 필요한 방법을 제공해 준다.

### 학습 테스트와 통합 테스트를 위한 DataSource

- SimpleDriverDataSource
  - 스프링이 제공하는 가장 단순한 DataSource 구현 클래스
  - getConnection()을 호출할 때마다 매번 DB 커넥션을 새로 만들고 따로 풀을 관리하지 않음
- SingleConnectionDataSource
  - 하나의 물리적인 DB 커넥션만 만들어두고 이를 계속 사용하는 DataSource
  - 순차적으로 진행되는 통합 테스트에서는 사용 가능하나 동시에 두 개 이상의 스레드가 동작하는 경우에는 하나의 커넥션을 공유하게 되므로 위험함
