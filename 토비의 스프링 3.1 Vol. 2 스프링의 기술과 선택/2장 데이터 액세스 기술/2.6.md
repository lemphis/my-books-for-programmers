# 2.6 트랜잭션

`선언적 트랜잭션 경계 설정` 기능을 이용하면 코드 내에서 직접 트랜잭션을 관리하고 트랜잭션 정보를 파라미터로 넘겨서 사용하지 않아도 된다.  
트랜잭션이 시작되고 종료되는 지점은 별도의 설정을 통해 결정된다.  
또 작은 단위로 분리되어 있는 데이터 액세스 로직과 비즈니스 로직 컴포넌트와 메서드를 조합해서 하나의 트랜잭션에서 동작하게 만드는 것도 선언적 트랜잭션이 제공하는 트랜잭션 전파 기능 적분에 가능하다.

## 2.6.1 트랜잭션 추상화와 동기화

스프링이 제공하는 트랜잭션 서비스는 `트랜잭션 추상화`와 `트랜잭션 동기화` 두 가지로 생각해 볼 수 있다.  
스프링은 데이터 액세스 기술과 트랜잭션 서비스 사이의 종속성을 제거하고 스프링이 제공하는 트랜잭션 추상 계층을 이용해서 트랜잭션 기능을 활용하도록 만들어준다.  
이를 통해 트랜잭션 서비스의 종류나 환경이 바뀌더라도 트랜잭션을 사용하는 코드는 그대로 유지할 수 있는 유연성을 얻을 수 있다.  
스프링의 트랜잭션 동기화는 트랜잭션을 일정 범위 안에서 유지해 주고, 어디서든 자유롭게 접근할 수 있게 만들어준다.

### PlatformTransactionManager

스프링 트랜잭션 추상화의 핵심 인터페이스는 `PlatformTransactionManager`다.  
모든 스프링의 트랜잭션 기능과 코드는 이 인터페이스를 통해서 로우 레벨의 트랜잭션 서비스를 이용할 수 있다.  
PlatformTransactionManager는 세 개의 메서드를 가지고 있다.

```java
public interface PlatformTransactionManager extends TransactionManager {
    TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException;
    void commit(TransactionStatus status) throws TransactionException;
    void rollback(TransactionStatus status) throws TransactionException;
}
```

getTransaction() 메서드는 트랜잭션 속성에 따라서 새로 시작하거나 진행 중인 트랜잭션에 참여하거나, 진행 중인 트랜잭션을 무시하고 새로운 트랜잭션을 만드는 식으로 상황에 따라 다르게 동작한다.  
TransactionDefinition은 트랜잭션의 네 가지 속성을 나타내는 인터페이스다.  
TransactionStatus는 현재 참여하고 있는 트랜잭션의 ID와 구분 정보를 담고 있다.  
커밋 또는 롤백 시에 이 TransactionStatus을 사용한다.

### 트랜잭션 매니저의 종류

- DataSourceTransactionManager
  - Connection의 트랜잭션 API를 이용해서 트랜잭션을 관리해 주는 트랜잭션 매니저
  - DataSourceTransactionManager를 사용하려면 트랜잭션을 적용할 DataSource가 스프링의 빈으로 등록되어야 함
  - JDBC API를 이용해서 트랜잭션을 관리하는 데이터 액세스 기술인 JDBC와 iBatis SqlMap으로 만든 DAO에 적용할 수 있음
  - DataSourceTransactionManager가 사용할 DataSource는 getConnection()이 호출될 때마다 매번 새로운 Connection을 돌려줘야 함
- JpaTransactionManager
  - JPA를 이용하는 DAO에서 사용되며 JTA로 트랜잭션 서비스를 이용하는 경우에는 필요하지 않음
  - LocalContainerEntityManagerFactoryBean 타입의 빈을 프로퍼티로 설정해야 함
  - DataSourceTransactionManager가 제공하는 DataSource 레벨의 트랜잭션 관리 기능을 동시에 제공하기 때문에 JpaTransactionManager를 사용하면서 동시에 트랜잭션이 적용된 JDBC DAO 사용 가능
- HibernateTransactionManager
  - 하이버네이트 DAO에 사용
  - SessionFactory 타입의 빈을 프로퍼티로 설정해야 함
  - DataSource 레벨의 트랜잭션 관리 기능을 동시에 제공
- JtaTransactionManager
  - 하나 이상의 DB 또는 트랜잭션 리소스가 참여하는 글로벌 트랜잭션을 적용하기 위해 사용
  - 여러 개의 트랜잭션 리소스(DB, JMS 등)에 대한 작업을 하나의 트랜잭션으로 묶을 수 있고, 여러 대의 서버에 분산되어 진행되는 작업을 트랜잭션으로 연결해 주기도 함
  - JTA 트랜잭션을 이용하려면 트랜잭션 서비스를 제공하는 WAS를 이용하거나 독립 JTA 서비스를 제공해 주는 프레임워크를 사용해야 함
