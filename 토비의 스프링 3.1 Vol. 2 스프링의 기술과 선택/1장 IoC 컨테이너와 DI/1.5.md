# 1.5 스프링 3.1의 Ioc 컨테이너와 DI

스프링 3.1에 새롭게 도입된 IoC/DI 기술은 다음 두 가지다.

- 강화된 자바 코드 빈 설정
  - 자바 코드를 이용한 설정 방식을 빈 설정 메타 정보 작성에 본격적으로 사용할 수 있도록 기능을 대폭 확장한 것
- 런타임 환경 추상화
  - 개발과 테스트, 운영 단계에서 IoC/DI 구성이 달라질 때 이를 효과적으로 관리할 수 있게 해주는 런타임 환경 정보 관리 기능

## 1.5.1 빈의 역할과 구분

### 빈의 종류

- 애플리케이션 로직 빈
  - 애플리케이션의 로직을 담고 있는 주요 클래스의 오브젝트
  - 데이터 로직을 다루는 DAO, 비즈니스 로직과 기반 서비스를 다루는 서비스 오브젝트, 컨트롤러 오브젝트 등이 대표적임
- 애플리케이션 인프라 빈
  - 애플리케이션이 동작하는 데 직접 참여하나 개발자가 직접 작성하는 로직을 담고 있지 않은 오브젝트
  - DataSource, DataSourceTransactionManager가 대표적임
- 컨테이너 인프라 빈
  - 애플리케이션 로직을 담고 있지 않으며 다른 애플리케이션 로직을 담은 빈과 관계를 맺고 외부 서비스를 사용하는 데 도움을 주진 않지만 스프링 컨테이너의 기능에 관여하는 오브젝트
  - DefaultAdvisorAutoProxyCreator가 대표적임

### 컨테이너 인프라 빈과 전용 태그

컨테이너 인프라 빈은 DefaultAdvisorAutoProxyCreator처럼 \<bean> 태그를 이용해 직접 빈을 등록할 수 있지만 전용 태그를 사용하는 방법이 더 많이 쓰인다.  
@Configuration/@Bean은 물론이고 @Autowired 같은 애노테이션을 이용한 빈 의존 관계 설정 방식, @PostConstruct를 통한 빈 초기화 메서드 기능 모두 스프링 컨테이너가 기본적으로 제공하는 기능이 아니라 스프링 컨테이너의 기능을 확장할 수 있는 컨테이너 인프라 빈이 제공하는 기능이다.

\<context:annotation-config> 태그를 추가하면 6개의 컨테이너 인프라 빈이 추가로 등록된다.

- ConfigurationClassPostProcessor$ImportAwareBeanPostProcessor
- ConfigurationClassPostProcessor
- AutowiredAnnotationBeanPostProcessor
- RequiredAnnotationBeanPostProcessor
- PersistenceAnnotationBeanPostProcessor

### 빈의 역할

스프링의 BeanDefinition 인터페이스에는 ROLE_로 시작하는 상수가 있다.  
이 상숫값은 빈의 메타 정보 오브젝트의 role 프로퍼티 값을 지정할 때 사용되는 것이다.  
BeanDefinition에는 다음과 같은 3개의 역할이 정의되어 있다.  
스프링의 빈을 역할에 따라 구분한다면 이 세 가지로 나눌 수 있다.

```java
// 애플리케이션 로직 빈과 애플리케이션 인프라 빈처럼 애플리케이션이 동작하는 중에 사용되는 빈
int ROLE_APPLICATION = 0;
// 복합 구조의 빈을 정의할 때 보조적으로 사용되는 빈. 거의 사용되지 않음
int ROLE_SUPPORT = 1;
// 컨테이너 인프라 빈
int ROLE_INFRASTRUCTURE = 2;
```

스프링 3.1부터는 개발자가 빈을 정의할 때 이 역할 값을 직접 지정할 수 있도록 @Role이라는 애노테이션이 도입됐다.

## 1.5.2 컨테이너 인프라 빈을 위한 자바 코드 메타정보

스프링의 빈을 역할에 따라 세 가지로 구분하는 이유는 빈 설정 메타 정보를 작성하는 방법과 전략을 각각 다르게 가져갈 수 있기 때문이다.

### 자바 코드를 이용한 컨테이너 인프라 빈 등록

아래는 IoC/DI와 관련된 애노테이션이다.

- @ComponentScan
  - XML에서 \<context:component-scan>을 사용한 것처럼 스테레오타입 애노테이션이 붙은 빈을 자동으로 스캔하여 등록
  - basePackageClasses 엘리먼트를 사용하여 마커 클래스나 인터페이스의 패키지를 빈 스캐닝의 기준 패키지가 되도록 설정 가능
- @Import
  - 다른 @Configuration 클래스를 빈 메타 정보에 추가할 때 사용
  - @Enable로 시작하는, 컨테이너 인프라 빈을 위한 전용 애노테이션을 만들 때 많이 사용됨
- @ImportResource
  - XML 파일의 빈 설정을 가져올 수 있음
- @EnableTransactionManagement
  - XML의 \<tx:annotation-driven> 태그와 동일한 기능 수행
  - @Transactional로 트랜잭션 속성을 지정할 수 있게 해주는 AOP 관련 빈을 등록해 줌

## 1.5.4 런타임 환경 추상화와 프로파일

스프링의 빈 설정 메타 정보는 빈의 클래스와 값 속성, 다른 빈과의 관계로 이루어져 있다.  
애플리케이션의 기능이 바뀌지 않으면 메타 정보도 대부분 바뀌지 않는다.  
하지만 애플리케이션이 동작하는 환경에 따라서 바뀌어야 하는 것도 있다.  
특히 외부 리소스나 서버 환경과 관련이 깊은 애플리케이션 인프라 빈의 클래스와 속성은 같은 애플리케이션이라고 하더라도 실행 환경에 따라 달라질 수 있다.

### 환경에 따른 빈 설정 정보 변경 전략과 한계

스프링으로 만든 애플리케이션은 성격이 다른 여러 환경에서 동작하게 된다.  
이렇게 애플리케이션이 실행되는 환경이 달라지면 일부 빈은 환경에 맞게 설정 메타 정보를 다르게 구성해야 한다.  
아래는 환경에 맞게 빈의 설정 정보가 달라질 수 있게 하는 방법이다.

- 빈 설정 파일의 변경
  - 메타 정보를 담은 XML이나 클래스를 따로 준비하고 각 환경에서 스프링 애플리케이션을 실행할 때 다른 설정 파일을 사용하게 하는 방법
  - 관리하기 번거로우며 실수가 발생할 여지가 있어서 바람직하지 못함
- 프로퍼티 파일 활용
  - 환경에 따라 달라지는 정보를 담은 프로퍼티 파일을 활용하는 방법
  - 빈 설정 메타 정보를 담은 XML이나 @Configuration 클래스는 애플리케이션 로직이 바뀌지 않는 한 건드리지 않고 환경에 따라 달라지는 외부 정보만 프로퍼티 파일 등에 두고 읽어서 사용하는 방법
  - 애플리케이션을 구성하는 빈의 설정 정보를 환경에 독립적으로 작성해서 환경이 바뀌어도 설정 파일은 수정할 필요가 없음

### 런타임 환경과 프로파일

런타임 환경은 스프링 3.1에서 새롭게 도입된 개념이다.  
컨텍스트 내부에 `Environment` 인터페이스를 구현한 런타임 환경 오브젝트가 만들어져서 빈을 생성하거나 오브젝트를 의존 관계를 주입할 때 사용된다.  
런타임 환경은 프로파일(profile) 프로퍼티 소스(property source)로 구성된다.  
환경에 따라 프로파일과 프로퍼티 소스가 다르게 설정된 Environment 오브젝트가 사용되는 식이다.  
환경에 따라 다르게 구성되는 빈들은 다른 이름을 가진 프로파일 안에 정의하고, 애플리케이션 컨텍스트가 시작될 때 지정된 프로파일에 속한 빈들만 생성되게 하는 방식이다.

### 활성 프로파일 지정 방법

특정 프로파일에 정의된 빈을 사용하고 싶으면 해당 프로파일을 활성(active) 프로파일로 만들어주면 된다.

### 프로퍼티 활용 전략

@Configuration이 붙은 클래스를 이용해 빈을 정의하는 경우에는 @Profile 애노테이션을 사용해 해당 클래스에 정의된 빈이 적용될 프로파일 이름을 지정해 주면 된다.
