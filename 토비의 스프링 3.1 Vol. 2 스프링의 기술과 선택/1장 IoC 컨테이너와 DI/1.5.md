# 1.5 스프링 3.1의 Ioc 컨테이너와 DI

스프링 3.1에 새롭게 도입된 IoC/DI 기술은 다음 두 가지다.

- 강화된 자바 코드 빈 설정
  - 자바 코드를 이용한 설정 방식을 빈 설정 메타 정보 작성에 본격적으로 사용할 수 있도록 기능을 대폭 확장한 것
- 런타임 환경 추상화
  - 개발과 테스트, 운영 단계에서 IoC/DI 구성이 달라질 때 이를 효과적으로 관리할 수 있게 해주는 런타임 환경 정보 관리 기능

## 1.5.1 빈의 역할과 구분

### 빈의 종류

- 애플리케이션 로직 빈
  - 애플리케이션의 로직을 담고 있는 주요 클래스의 오브젝트
  - 데이터 로직을 다루는 DAO, 비즈니스 로직과 기반 서비스를 다루는 서비스 오브젝트, 컨트롤러 오브젝트 등이 대표적임
- 애플리케이션 인프라 빈
  - 애플리케이션이 동작하는 데 직접 참여하나 개발자가 직접 작성하는 로직을 담고 있지 않은 오브젝트
  - DataSource, DataSourceTransactionManager가 대표적임
- 컨테이너 인프라 빈
  - 애플리케이션 로직을 담고 있지 않으며 다른 애플리케이션 로직을 담은 빈과 관계를 맺고 외부 서비스를 사용하는 데 도움을 주진 않지만 스프링 컨테이너의 기능에 관여하는 오브젝트
  - DefaultAdvisorAutoProxyCreator가 대표적임

### 컨테이너 인프라 빈과 전용 태그

컨테이너 인프라 빈은 DefaultAdvisorAutoProxyCreator처럼 \<bean> 태그를 이용해 직접 빈을 등록할 수 있지만 전용 태그를 사용하는 방법이 더 많이 쓰인다.  
@Configuration/@Bean은 물론이고 @Autowired 같은 애노테이션을 이용한 빈 의존 관계 설정 방식, @PostConstruct를 통한 빈 초기화 메서드 기능 모두 스프링 컨테이너가 기본적으로 제공하는 기능이 아니라 스프링 컨테이너의 기능을 확장할 수 있는 컨테이너 인프라 빈이 제공하는 기능이다.

\<context:annotation-config> 태그를 추가하면 6개의 컨테이너 인프라 빈이 추가로 등록된다.

- ConfigurationClassPostProcessor$ImportAwareBeanPostProcessor
- ConfigurationClassPostProcessor
- AutowiredAnnotationBeanPostProcessor
- RequiredAnnotationBeanPostProcessor
- PersistenceAnnotationBeanPostProcessor

### 빈의 역할

스프링의 BeanDefinition 인터페이스에는 ROLE\_로 시작하는 상수가 있다.  
이 상숫값은 빈의 메타 정보 오브젝트의 role 프로퍼티 값을 지정할 때 사용되는 것이다.  
BeanDefinition에는 다음과 같은 3개의 역할이 정의되어 있다.  
스프링의 빈을 역할에 따라 구분한다면 이 세 가지로 나눌 수 있다.

```java
// 애플리케이션 로직 빈과 애플리케이션 인프라 빈처럼 애플리케이션이 동작하는 중에 사용되는 빈
int ROLE_APPLICATION = 0;
// 복합 구조의 빈을 정의할 때 보조적으로 사용되는 빈. 거의 사용되지 않음
int ROLE_SUPPORT = 1;
// 컨테이너 인프라 빈
int ROLE_INFRASTRUCTURE = 2;
```

스프링 3.1부터는 개발자가 빈을 정의할 때 이 역할 값을 직접 지정할 수 있도록 @Role이라는 애노테이션이 도입됐다.

## 1.5.2 컨테이너 인프라 빈을 위한 자바 코드 메타정보

스프링의 빈을 역할에 따라 세 가지로 구분하는 이유는 빈 설정 메타 정보를 작성하는 방법과 전략을 각각 다르게 가져갈 수 있기 때문이다.

### 자바 코드를 이용한 컨테이너 인프라 빈 등록

아래는 IoC/DI와 관련된 애노테이션이다.

- @ComponentScan
  - XML에서 \<context:component-scan>을 사용한 것처럼 스테레오타입 애노테이션이 붙은 빈을 자동으로 스캔하여 등록
  - basePackageClasses 엘리먼트를 사용하여 마커 클래스나 인터페이스의 패키지를 빈 스캐닝의 기준 패키지가 되도록 설정 가능
- @Import
  - 다른 @Configuration 클래스를 빈 메타 정보에 추가할 때 사용
  - @Enable로 시작하는, 컨테이너 인프라 빈을 위한 전용 애노테이션을 만들 때 많이 사용됨
- @ImportResource
  - XML 파일의 빈 설정을 가져올 수 있음
- @EnableTransactionManagement
  - XML의 \<tx:annotation-driven> 태그와 동일한 기능 수행
  - @Transactional로 트랜잭션 속성을 지정할 수 있게 해주는 AOP 관련 빈을 등록해 줌

## 1.5.4 런타임 환경 추상화와 프로파일

스프링의 빈 설정 메타 정보는 빈의 클래스와 값 속성, 다른 빈과의 관계로 이루어져 있다.  
애플리케이션의 기능이 바뀌지 않으면 메타 정보도 대부분 바뀌지 않는다.  
하지만 애플리케이션이 동작하는 환경에 따라서 바뀌어야 하는 것도 있다.  
특히 외부 리소스나 서버 환경과 관련이 깊은 애플리케이션 인프라 빈의 클래스와 속성은 같은 애플리케이션이라고 하더라도 실행 환경에 따라 달라질 수 있다.

### 환경에 따른 빈 설정 정보 변경 전략과 한계

스프링으로 만든 애플리케이션은 성격이 다른 여러 환경에서 동작하게 된다.  
이렇게 애플리케이션이 실행되는 환경이 달라지면 일부 빈은 환경에 맞게 설정 메타 정보를 다르게 구성해야 한다.  
아래는 환경에 맞게 빈의 설정 정보가 달라질 수 있게 하는 방법이다.

- 빈 설정 파일의 변경
  - 메타 정보를 담은 XML이나 클래스를 따로 준비하고 각 환경에서 스프링 애플리케이션을 실행할 때 다른 설정 파일을 사용하게 하는 방법
  - 관리하기 번거로우며 실수가 발생할 여지가 있어서 바람직하지 못함
- 프로퍼티 파일 활용
  - 환경에 따라 달라지는 정보를 담은 프로퍼티 파일을 활용하는 방법
  - 빈 설정 메타 정보를 담은 XML이나 @Configuration 클래스는 애플리케이션 로직이 바뀌지 않는 한 건드리지 않고 환경에 따라 달라지는 외부 정보만 프로퍼티 파일 등에 두고 읽어서 사용하는 방법
  - 애플리케이션을 구성하는 빈의 설정 정보를 환경에 독립적으로 작성해서 환경이 바뀌어도 설정 파일은 수정할 필요가 없음

### 런타임 환경과 프로파일

런타임 환경은 스프링 3.1에서 새롭게 도입된 개념이다.  
컨텍스트 내부에 `Environment` 인터페이스를 구현한 런타임 환경 오브젝트가 만들어져서 빈을 생성하거나 오브젝트를 의존 관계를 주입할 때 사용된다.  
런타임 환경은 프로파일(profile) 프로퍼티 소스(property source)로 구성된다.  
환경에 따라 프로파일과 프로퍼티 소스가 다르게 설정된 Environment 오브젝트가 사용되는 식이다.  
환경에 따라 다르게 구성되는 빈들은 다른 이름을 가진 프로파일 안에 정의하고, 애플리케이션 컨텍스트가 시작될 때 지정된 프로파일에 속한 빈들만 생성되게 하는 방식이다.

### 활성 프로파일 지정 방법

특정 프로파일에 정의된 빈을 사용하고 싶으면 해당 프로파일을 활성(active) 프로파일로 만들어주면 된다.

### 프로퍼티 활용 전략

@Configuration이 붙은 클래스를 이용해 빈을 정의하는 경우에는 @Profile 애노테이션을 사용해 해당 클래스에 정의된 빈이 적용될 프로파일 이름을 지정해 주면 된다.

## 1.5.5 프로퍼티 소스

### 프로퍼티

단순히 프로퍼티 정보만 넣는다면 java.util.Properties에서 지원하는 프로퍼티 파일 포맷을 이용하는 것이 편리하다.  
그런데 Properties가 기본적으로 지원하는 프로퍼티 파일은 ISO-8859-1 인코딩만을 지원하기 때문에 영문만 사용할 수 있다.  
따라서 ISO-8859-1 인코딩으로 표현 불가능한 문자는 u로 시작하는 유니코드 값을 대신 사용해야 Properties에서 바르게 읽을 수 있다.

### 스프링에서 사용되는 프로퍼티 종류

스프링은 프로퍼티 파일 외에도 프로퍼티 값을 지정하고 가져오는 다양한 방법을 지원한다.

- 환경 변수
  - 스프링 애플리케이션이 구동되는 OS의 환경 변수도 키와 값으로 표현되는 대표적인 프로퍼티
  - 자바에서는 System.getEnv() 메서드로 환경 변수를 담은 프로퍼티 맵을 가져올 수 있음
  - 스프링에서는 환경 변수를 담은 프로퍼티 맵을 systemEnvironment 이름의 빈으로 가져올 수 있음
- 시스템 프로퍼티
  - JVM 레벨에 정의된 프로퍼티
  - JVM이 시작될 때 시스템 관련 정보(os.name, user.home 등)부터 자바 관련 정보(java.home, java.version, java.class.path 등), 기타 JVM 관련 정보들이 시스템 프로퍼티로 등록됨
  - JVM을 시작할 때 -D로 지정한 커맨드 라인 옵션도 포함됨
  - System.getProperties()로 Properties 타입의 시스템 프로퍼티를 가져올 수 있음
  - 환경 변수와 마찬가지로 스프링이 자동으로 등록해 주는 systemProperties 빈을 통해 접근 가능
- JNDI
  - WAS에 여러 개의 웹 애플리케이션이 올라가고 그중 하나의 애플리케이션에만 프로퍼티를 지정하고 싶은 경우 사용 고려
  - 주로 DataSource 풀 같은 리소스를 바인딩 해두고 이를 애플리케이션에서 가져와 사용하는 방법을 주로 사용
- 서블릿 컨텍스트 파라미터
  - web.xml에 서블릿 컨텍스트 초기 파라미터를 프로퍼티로 사용 가능
- 서블릿 컨픽 파라미터
  - 개별 서블릿을 위한 설정

### 프로파일의 통합과 추상화

다양한 프로퍼티 종류와 그에 따라 달라지는 접근 방법을 스프링 3.1에서는 프로퍼티 소스라는 개념으로 추상화하고, 프로퍼티의 저장 위치에 상관없이 동일한 API를 이용해 가져올 수 있게 해준다.  
프로퍼티 소스는 프로파일과 함께 런타임 환경 정보를 구성하는 핵심 정보다.  
Environment 타입의 런타임 오브젝트를 이용하면 일관된 방식으로 프로퍼티 정보를 가져올 수 있다.

StandardEnvironment는 GenericXmlApplicationContext나 ApplicationConfigApplicationContext처럼 독립형 애플리케이션용 컨텍스트에서 사용되는 런타임 환경 오브젝트다.  
StandardEnvironment는 기본적으로 다음 두 가지 종류의 프로퍼티 소스를 제공한다.

- 시스템 프로퍼티 소스
- 환경 변수 프로퍼티 소스

런타임 환경 오브젝트의 getProperty()를 호출하기만 하면 현재 런타임 환경에 등록된 모든 프로퍼티 소스를 뒤져서 프로퍼티 값을 찾아온다.  
이렇게 두 개 이상의 프로퍼티 소스를 가지고 있을 때 만약 양쪽에 동일한 키의 프로퍼티가 중복해서 존재한다면, 런타임 환경 오브젝트에 등록된 프로퍼티 소스의 우선순위를 따라 우선순위가 높은 프로퍼티 소스의 프로퍼티가 사용된다.

### 프로퍼티 소스의 사용

통합된 프로퍼티 정보를 스프링 애플리케이션에서 가져와 사용하는 방법은 다음과 같다.

- Environment.getProperty()
  - Environment 오브젝트를 빈에 주입받아서 직접 프로퍼티 값을 가져오는 방법
- PropertySourcePlaceholderConfigurer와 \<context:property-placeholder>
  - @Value와 프로퍼티 ${} 치환자를 사용하는 방법
  - @Value에 치환자를 사용하려면 컨텍스트에 PropertySourcePlaceholderConfigurer 빈이 등록되어 있어야 함
  - PropertySourcePlaceholderConfigurer는 특정 프로퍼티 파일이 아니라 환경 오브젝트에 통합된 프로퍼티 소스로부터 프로퍼티 값을 가져와 컨텍스트의 @Value 또는 XML에 있는 ${} 치환자의 값을 바꿔주는 기능 담당(PropertyPlaceholderConfigurer와 다름)
  - PropertySourcePlaceholderConfigurer 빈을 등록할 때는 @Bean 메서드를 반드시 static 메서드로 등록해야 함
  - 스프링 3.1부터는 PropertyPlaceholderConfigurer의 기능이 PropertySourcePlaceholderConfigurer로 통합됨

### @PropertySource와 프로퍼티 파일

`@PropertySource` 애노테이션을 사용하면 대표적인 프로퍼티 정보 저장 방식인 프로퍼티 파일도 프로퍼티 소스로 등록하고 사용할 수 있다.

### 웹 환경에서 사용되는 프로퍼티 소스와 프로퍼티 소스 초기화 오브젝트

루트 웹 컨텍스트나 서블릿 웹 컨텍스트에 의해 만들어지는 웹 애플리케이션 컨텍스트는 `StandardServletEnvironment` 타입의 런타임 환경 오브젝트를 사용한다.  
StandardServletEnvironment는 `StandardEnvironment`가 등록해 주는 환경 변수 프로퍼티 소스와 시스템 프로퍼티 소스에 더해서 JNDI 프로퍼티 소스, 서블릿 컨텍스트 프로퍼티 소스, 서블릿 컨픽 프로퍼티 소스를 추가로 등록해 준다.
