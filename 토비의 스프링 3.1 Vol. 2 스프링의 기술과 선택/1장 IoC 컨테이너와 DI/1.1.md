# 1.1 IoC 컨테이너: 빈 팩토리와 애플리케이션 컨텍스트

스프링 애플리케이션에서는 오브젝트의 생성과 관계 설정, 사용, 제거 등의 작업을 애플리케이션 코드 대신 독립된 컨테이너가 담당한다.  
이를 컨테이너가 코드 대신 오브젝트에 대한 제어권을 가지고 있다고 해서 `IoC`라고 부른다.  
그래서 스프링 컨테이너를 IoC 컨테이너라고도 한다.  
스프링에서는 IoC를 담당하는 컨테이너를 빈 팩토리 또는 애플리케이션 컨텍스트라고 부르기도 한다.  
오브젝트의 생성과 오브젝트 사이의 런타임 관계를 설정하는 DI 관점으로 볼 때는 컨테이너를 `빈 팩토리`라고 한다.  
DI를 위한 빈 팩토리에 엔터프라이즈 애플리케이션을 개발하는 데 필요한 여러 가지 컨테이너 기능을 추가한 것을 `애플리케이션 컨텍스트`라고 부른다.

실제로 스프링 컨테이너 또는 IoC 컨테이너라고 말하는 것은 바로 `ApplicationContext` 인터페이스를 구현한 클래스의 오브젝트다.  
스프링 애플리케이션은 최소한 하나 이상의 IoC 컨테이너, 즉 애플리케이션 컨텍스트 오브젝트를 가지고 있다.  
하나 이상이라고 하는 이유는 한 개 이상의 애플리케이션 컨텍스트 오브젝트를 가지고 있는 경우도 많기 때문이다.

## 1.1.1 IoC 컨테이너를 이용해 애플리케이션 만들기

컨테이너가 본격적인 IoC 컨테이너로서 동작하려면 POJO 클래스와 설정 메타 정보가 필요하다.

### POJO 클래스

각각의 POJO는 특정 기술과 스펙에서 독립적일뿐더러 의존 관계에 있는 다른 POJO와 느슨한 결합을 갖도록 만들어야 한다.  
각자 기능에 충실하게 독립적으로 설계된 POJO 클래스를 만들고, 결합도가 낮은 유연한 관계를 가질 수 있도록 인터페이스를 이용해 연결해 줘야 한다.

### 설정 메타 정보

만든 POJO 클래스들 중에 애플리케이션에서 사용할 것을 선정하고 이를 IoC 컨테이너가 제어할 수 있도록 적절한 메타 정보를 만들어 제공하는 작업이다.  
IoC 컨테이너의 가장 기초적인 역할은 오브젝트를 생성하고 이를 관리하는 것이다.  
스프링 컨테이너가 관리하는 이런 오브젝트는 `빈(bean)`이라고 부른다.  
IoC 컨테이너가 필요로 하는 설정 메타 정보는 바로 이 **빈을 어떻게 만들고 어떻게 동작해야 할 것인가**에 관한 정보다.

스프링의 설정 메타 정보는 `BeanDefinition` 인터페이스로 표현되는 순수한 추상 정보다.  
스프링 IoC 컨테이너, 즉 애플리케이션 컨텍스트는 바로 이 BeanDefinition으로 만들어진 메타 정보를 담은 오브젝트를 사용해 IoC와 DI 작업을 수행한다.  
따라서 **스프링의 메타 정보는 특정한 파일 포맷이나 형식에 제한되거나 종속되지 않는다**.  
원본의 포맷과 구조, 자료의 특성에 맞게 읽어와 BeanDefinition 오브젝트로 변환해 주는 `BeanDefinitionReader`가 있으면 된다.

BeanDefinition 인터페이스로 정의되는, IoC 컨테이너가 사용하는 빈 메타 정보는 대략 다음과 같다.

- 빈 아이디, 이름, 별칭: 빈 오브젝트를 구분할 수 있는 식별자
- 클래스 또는 클래스 이름: 빈으로 만들 POJO 클래스 또는 서비스 클래스 정보
- 스코프: 싱글톤, 프로토타입과 같은 빈의 생성 방식과 존재 범위
- 프로퍼티 값 또는 참조: DI에 사용할 프로퍼티 이름과 값 또는 참조하는 빈의 이름
- 생성자 파라미터 값 또는 참조: DI에 시용할 생성자 파라미터 이름과 값 또는 참조할 빈의 이름
- 지연된 로딩 여부, 우선 빈 여부, 자동 와이어링 여부, 부모 빈 정보, 빈 팩토리 이름 등

스프링 IoC 컨테이너는 각 빈에 대한 정보를 담은 설정 메타 정보를 읽어들인 뒤에, 이를 참고해서 빈 오브젝트를 생성하고 프로퍼티나 생성자를 통해 의존 오브젝트를 주입해 주는 DI 작업을 수행한다.

결국 스프링 애플리케이션이란 POJO 클래스와 설정 메타 정보를 이용해 IoC 컨테이너가 만들어주는 오브젝트의 조합이라고 할 수 있다.

IoC 컨테이너는 일단 빈 오브젝트가 생성되고 관계가 만들어지면 그 뒤로는 거의 관여하지 않는다.  
기본적으로 싱글톤 빈은 애플리케이션 컨텍스트의 초기화 작업 중에 모두 만들어진다.

## 1.1.2 IoC 컨테이너의 종류와 사용 방법

다음은 스프링이 제공하는 ApplicationContext 구현 클래스의 종류와 사용 방법이다.

- StaticApplicationContext
  - 코드를 통해 빈 설정 메타 정보를 등록하기 위해 사용
  - 스프링의 기능에 대한 학습 테스트를 만들 때를 제외하면 실제로 사용되지 않음
- GenericApplicationContext
  - 가장 일반적인 애플리케이션 컨텍스트의 구현 클래스
  - 컨테이너의 주요 기능을 DI를 통해 확장할 수 있도록 설계되어 있음
  - XML 파일과 같은 외부의 리소스에 있는 빈 설정 메타 정보를 Reader를 통해 읽어들여서 메타 정보로 전환함
  - JUnit에서 사용됨
- GenericXmlApplicationContext
  - GenericApplicationContext, XmlBeanDefinitionReader가 결합된 클래스
  - XML 파일로 설정을 만들고 애플리케이션 컨텍스트에서 XML을 읽어서 사용하는 코드를 시험 삼아 만들어볼 필요가 있을 때 사용하기에 적절함
- WebApplicationContext
  - 스프링 애플리케이션에서 가장 많이 사용되는 애플리케이션 컨텍스트
  - 웹 환경에서 사용할 때 필요한 기능이 추가됨

스프링 IoC 컨테이너는 빈 설정 메타 정보를 이용해 빈 오브젝트를 만들고 DI 작업을 수행한다.  
하지만 그것만으로는 애플리케이션이 동작하지 않는다.  
마치 자바 애플리케이션의 main() 메서드처럼 어디에선가 특정 빈 오브젝트의 메서드를 호출함으로써 애플리케이션을 동작시켜야 한다.  
보통 이런 기동 역할을 맡은 빈을 사용하려면 IoC 컨테이너에서 요청해서 빈 오브젝트를 가져와야 한다.  
IoC 컨테이너의 역할은 초기에 빈 오브젝트를 생성하고 DI 한 후에 최초로 애플리케이션을 기동할 빈 하나를 제공해 주는 것까지다.

그런데 테스트나 독립형 애플리케이션이라면 모르겠지만, 웹 애플리케이션은 동작하는 방식이 근본적으로 다르다.  
독립 자바 프로그램은 JVM에게 main() 메서드를 가진 클래스를 시작시켜 달라고 요청할 수 있다.  
하지만 웹에서는 main() 메서드를 호출할 방법이 없으며 사용자도 여럿이고 동시에 웹 애플리케이션을 사용한다.  
그래서 **웹 환경에서는 main() 메서드 대신 서블릿 컨테이너가 브라우저로부터 오는 HTTP 요청을 받아서 해당 요청에 매핑되어 있는 서블릿을 실행해 주는 방식으로 동작**한다.  
서블릿이 일종의 main() 메서드와 같은 역할을 하는 셈이다.

서블릿 컨테이너는 브라우저와 같은 클라이언트로부터 들어오는 요청을 받아서 서블릿을 동작시켜주는 일을 맡는다.  
서블릿은 웹 애플리케이션이 시작될 때 미리 만들어둔 웹 애플리케이션 컨텍스트에게 빈 오브젝트로 구성된 애플리케이션의 기동 역할을 해줄 빈을 요청해서 받아둔다.  
그리고 미리 지정된 메서드를 호출함으로써 스프링 컨테이너가 DI 방식으로 구성해둔 애플리케이션의 기능이 시작되는 것이다.

스프링은 이런 웹 환경에서 애플리케이션 컨텍스트를 생성하고 설정 메타 정보로 초기화해주고, 클라이언트로부터 들어오는 요청마다 적절한 빈을 찾아서 이를 실행해 주는 기능을 가진 `DispatcherServlet`이라는 이름의 서블릿을 제공한다.

## 1.1.3 IoC 컨테이너 계층구조

한 개 이상의 IoC 컨테이너를 만들어두고 사용해야 할 경우가 있다.  
바로 트리 모양의 계층 구조를 만들 때다.

### 부모 컨텍스트를 이용한 계층 구조 효과

모든 애플리케이션 컨텍스트는 부모 애플리케이션 컨텍스트를 가질 수 있다.  
이를 이용하면 트리 구조의 컨텍스트 계층을 만들 수 있다.  
계층 구조 안의 모든 컨텍스트는 각자 독립적인 설정 정보를 이용해 빈 오브젝트를 만들고 관리한다.  
각자 독립적으로 자신이 관리하는 빈을 가지고 있긴 하지만 DI를 위해 빈을 찾을 때는 부모 애플리케이션 컨텍스트의 빈까지 모두 검색한다.

중요한 건 자신의 부모 컨텍스트에만 빈 검색을 요청하지 자식 컨텍스트에게는 요청하지 않는다는 점이다.  
그런 이유로 같은 레벨에 있는 형제 컨텍스트의 빈도 찾을 수 없다.

기본적으로 **스프링 웹 애플리케이션은 부모/자식 관계를 가진 두 개의 애플리케이션 컨텍스트로 구성된 계층 구조**로 만들어진다.

### 컨텍스트 계층 구조 테스트

루트 컨텍스트는 반드시 스스로 완전한 빈 의존 관계를 보장해야 한다.  
자신 외에는 다른 데서 필요한 빈을 찾을 방법이 없기 때문이다.

## 1.1.4 웹 애플리케이션의 IoC 컨테이너 구성

최근에는 많은 웹 요청을 한 번에 받을 수 있는 대표 서블릿을 등록해두고, 공통적인 선행 작업을 수행하게 한 후에, 각 요청의 기능을 담당하는 핸들러라고 불리는 클래스를 호출하는 방식으로 개발하는 경우가 일반적이다.  
몇 개의 서블릿이 중앙 집중식으로 모든 요청을 다 받아서 처리하는 이런 방식을 `프론트 컨트롤러 패턴`이라고 한다.

웹 애플리케이션 안에서 동작하는 IoC 컨테이너는 두 가지 방법으로 만들어진다.

- 스프링 애플리케이션의 요청을 처리하는 서블릿 안에서 만들어지는 것
- 웹 애플리케이션 레벨에서 만들어지는 것

일반적으로는 위 두 가지 방법을 모두 사용해 컨테이너를 만든다.  
그래서 스프링 웹 애플리케이션에는 두 개의 컨테이너(WebApplicationContext) 오브젝트가 만들어진다.

### 웹 애플리케이션의 컨텍스트 계층 구조

웹 애플리케이션 레벨에 등록되는 컨테이너는 보통 `루트 웹 애플리케이션 컨텍스트`라고 불린다.  
이 컨텍스트는 서블릿 레벨에 등록되는 컨테이너들의 부모 컨테이너가 되고, 일반적으로 전체 계층 구조 내에서 가장 최상단에 위치한 루트 컨텍스트가 된다.

웹 애플리케이션에서는 하나 이상의 스프링 애플리케이션의 프론트 컨트롤러 역할을 하는 서블릿이 등록될 수 있다.  
이 서블릿에는 각각 독립적으로 애플리케이션 컨텍스트가 만들어진다.  
일반적으로는 **스프링의 애플리케이션 컨텍스트를 가지면서 프론트 컨트롤러 역할을 하는 서블릿은 하나만 만들어 사용**한다.

이렇게 애플리케이션 컨텍스트를 계층 구조로 만드는 이유는 **전체 애플리케이션에서 웹 기술에 의존적인 부분과 그렇지 않은 부분을 구분**하기 위해서다.

애플리케이션 컨텍스트의 계층 구조가 만들어지기 때문에 계층 구조를 사용할 때의 모든 주의사항을 항상 염두에 둬야 한다.

- 서블릿의 컨텍스트 빈은 루트 애플리케이션 컨텍스트의 빈을 참조할 수 있지만 그 반대는 참조 불가
- 루트 컨텍스트에 정의된 빈은 이름이 같은 서블릿 컨텍스트의 빈이 존재하면 무시될 수 있음
- 하나의 컨텍스트에 정의된 AOP 설정은 다른 컨텍스트의 빈에는 영향을 미치지 않음

### 웹 애플리케이션 컨텍스트 구성 방법

- 서블릿 컨텍스트와 루트 애플리케이션 컨텍스트 계층 구조
  - 가장 많이 사용되는 기본적인 구성 방법
  - 스프링 웹 기술을 사용하는 경우 웹 관련 빈들은 서블릿의 컨텍스트에 두고 나머지는 루트 애플리케이션 컨텍스트에 등록
- 루트 애플리케이션 컨텍스트 단일 구조
  - 스프링 웹 기술을 사용하지 않고 서드 파티 웹 프레임워크나 서비스 엔진만을 사용해서 프레젠테이션 계층을 만들 경우 사용
- 서블릿 컨텍스트 단일 구조
  - 스프링 웹 기술을 사용하면서 스프링 외의 프레임워크나 서비스 엔진에서 스프링의 빈을 이용할 생각이 아닌 경우 루트 애플리케이션 생략 가능
  - 서블릿 안에 만들어지는 애플리케이션 컨텍스트가 부모 컨텍스트를 갖지 않기 때문에 스스로 루트 컨텍스트가 됨

### 루트 애플리케이션 컨텍스트 등록

웹 애플리케이션 레벨에 만들어지는 루트 웹 애플리케이션 컨텍스트를 등록하는 가장 간단한 방법은 서블릿의 이벤트 리스너(event listener)를 이용하는 것이다.  
스프링은 웹 애플리케이션의 시작과 종료 시 발생하는 이벤트를 처리하는 리스너인 `ServletContextListener`를 이용한다.  
이를 이용해서 웹 애플리케이션이 시작될 때 루트 애플리케이션 컨텍스트를 만들어 초기화하고, 웹 애플리케이션이 종료될 때 컨텍스트를 함께 종료하는 기능을 가진 리스너인 `ContextLoaderListener`를 제공한다.  
ContextLoaderListener는 웹 애플리케이션이 시작될 때 자동으로 루트 애플리케이션 컨텍스트를 만들고 초기화해준다.  
ContextLoaderListener는 별다른 파라미터를 지정하지 않으면, 디폴트로 설정된 다음의 값이 적용된다.

- 애플리케이션 컨텍스트 클래스: XmlWebApplicationContext
- XML 설정 파일 위치: /WEB-INF/applicationContext.xml

### 서블릿 애플리케이션 컨텍스트 등록

스프링의 웹 기능을 지원하는 프론트 컨트롤러 서블릿은 `DispatcherServlet`이다.  
서블릿 이름을 다르게 지정해 주면 하나의 웹 애플리케이션에 여러 개의 DispatcherServlet을 등록할 수도 있다.  
각 DispatcherServlet은 서블릿이 초기화될 때 자신만의 컨텍스트를 생성하고 초기화하며, 동시에 웹 애플리케이션 레벨에 등록된 루트 애플리케이션 컨텍스트를 찾아서 이를 자신의 부모 컨텍스트로 사용한다.
