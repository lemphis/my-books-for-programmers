# 6.4 스프링의 프록시 팩토리 빈

## 6.4.1 ProxyFactoryBean

스프링은 트랜잭션 기술과 메일 발송 기술에 적용했던 서비스 추상화를 프록시 기술에도 동일하게 적용하고 있다.  
자바에는 JDK에서 제공하는 다이내믹 프록시 외에도 편리하게 프록시를 만들 수 있도록 지원해 주는 다양한 기술이 존재한다.  
따라서 **스프링은 일관된 방법으로 프록시를 만들 수 있게 도와주는 추상 레이어를 제공**한다.

스프링의 `ProxyFactoryBean`은 프록시를 생성하여 빈 오브젝트를 등록하게 해주는 팩토리 빈이다.  
ProxyFactoryBean이 생성하는 프록시에서 사용할 부가 기능은 `MethodInterceptor` 인터페이스를 구현해서 만든다.  
MethodInterceptor는 InvocationHandler와 비슷하지만 한 가지 다른 점이 있다.  
InvocationHandler의 invoke() 메서드는 타깃 오브젝트에 대한 정보를 제공하지 않기 때문에 타깃은 InvocationHandler를 구현한 클래스가 직접 알고 있어야 한다.  
반면에 MethodInterceptor의 invoke() 메서드는 ProxyFactoryBean으로부터 타깃 오브젝트에 대한 정보까지도 함께 제공받는다.  
그 차이 덕분에 **MethodInterceptor는 타깃 오브젝트에 상관없이 독립적으로 만들어질 수 있다.**  
따라서 MethodInterceptor 오브젝트는 타깃이 다른 여러 프록시에서 함께 사용할 수 있고, 싱글톤 빈으로 등록 가능하다.

### 어드바이스: 타깃이 필요 없는 순수한 부가 기능

InvocationHandler를 구현했을 때와 달리 MethodInterceptor를 구현한 클래스에는 타깃 오브젝트가 등장하지 않는다.  
MethodInterceptor로는 메서드 정보와 함께 타깃 오브젝트가 담긴 MethodInvocation 오브젝트가 전달된다.  
MethodInvocation은 타깃 오브젝트의 메서드를 실행할 수 있는 기능이 있기 때문에 **MethodInterceptor는 부가 기능을 제공하는 데만 집중할 수 있다**.  
MethodInvocation은 일종의 콜백 오브젝트로, proceed() 메서드를 실행하면 타깃 오브젝트의 메서드를 내부적으로 실행해 주는 기능이 있다.  

ProxyFactoryBean에는 addAdvice() 메서드를 이용하여 여러 개의 MethodInterceptor를 추가할 수 있다.
MethodInterceptor처럼 타깃 오브젝트에 적용하는 부가 기능을 담은 오브젝트를 스프링에서는 `어드바이스(Advice)`라고 부른다.

### 포인트컷: 부가 기능 적용 대상 메서드 선정 방법

스프링은 메서드 선정 알고리즘을 담은 오브젝트를 `포인트컷(Pointcut)`이라고 부른다.  
어드바이스와 포인트컷은 모두 여러 프록시에서 공유가 가능하도록 만들어지기 때문에 스프링의 싱글톤 빈으로 등록하고 프록시에 DI로 주입돼서 사용된다.  
아래는 어드바이스, 포인트컷을 이용한 프록시 호출 과정 순서다.

1. 프록시는 클라이언트로부터 요청을 받으면 먼저 포인트컷에게 부가 기능을 부여할 메서드인지 확인해달라고 요청
2. 포인트컷으로부터 부가 기능을 적용할 대상 메서드인지 확인받으면, MethodInterceptor 타입의 어드바이스 호출
3. 어드바이스가 부가 기능을 부여하는 중에 타깃 메서드의 호출이 필요하면 프록시로부터 전달받은 MethodInvocation 타입 콜백 오브젝트의 proceed() 메서드 호출

실제 위임 대상인 타깃 오브젝트의 레퍼런스를 가지고 있고, 이를 이용해 타깃 메서드를 직접 호출하는 것은 프록시가 메서드 호출에 따라 만드는 Invocation 콜백의 역할이다.  
재사용 가능한 기능을 만들어두고 바뀌는 부분(콜백 오브젝트와 메서드 호출 정보)만 외부에서 주입해서 이를 작업 흐름(부가 기능 부여) 중에 사용하도록 하는 전형적인 템플릿/콜백 구조다.  
프록시로부터 어드바이스와 포인트컷을 독립시키고 DI를 사용하게 한 것은 전형적인 전략 패턴 구조다.

어드바이스와 포인트컷을 같이 등록하기 위해서는 Advisor 타입으로 묶어서 addAdvisor() 메서드를 호출해야 한다.  
포인트컷과 어드바이스를 따로 등록하면 어떤 어드바이스에 대해 어떤 포인트컷을 적용할지 애매해지기 때문이다.  
이렇게 어드바이스와 포인트컷을 묶은 오브젝트를 인터페이스 이름을 따서 `어드바이저(Advisor)`라고 부른다.

`어드바이저 = 포인트컷(메서드 선정 알고리즘) + 어드바이스(부가 기능)`

## 6.4.2 ProxyFactoryBean 적용

### 어드바이스와 포인트컷의 재사용

ProxyFactoryBean은 스프링의 DI와 템플릿/콜백 패턴, 서비스 추상화 등의 기법이 모두 적용된 것이다.  
그 덕분에 독립적이며, 여러 프록시가 공유할 수 있는 어드바이스와 포인트컷으로 확장 기능을 분리할 수 있었다.
