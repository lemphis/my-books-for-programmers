# 2.4 도메인 영역의 주요 구성요소

도메인 영역의 모델은 도메인의 주요 개념을 표현하며 핵심 로직을 구현한다.  
1장에서 살펴본 엔티티와 밸류 타입은 도메인 영역의 주요 구성요소이다.  
이 두 요소와 함께 도메인 영역을 구성하는 요소는 다음과 같다.

- 엔티티(ENTITY)
  - 고유의 식별자를 가지는 객체로 자신의 라이프 사이클을 가짐
  - 주문, 회원, 상품과 같이 도메인의 고유한 개념 표현
  - 도메인 모델의 데이터를 포함하며 해당 데이터와 관련된 기능을 함께 제공
- 밸류(VALUE)
  - 고유의 식별자를 가지지 않는 객체로 주로 개념적으로 하나인 값을 표현할 때 사용
  - 예를 들어 배송지 주소를 표현하기 위한 주소나 구매 금액을 위한 금액과 같은 타입이 있음
  - 엔티티의 속성으로 사용할 뿐만 아니라 다른 밸류 타입의 속성으로도 사용할 수 있음
- 애그리거트(AGGREGATE)
  - 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것
  - 예를 들어 주문과 관련된 Order 엔티티, OrderLine 밸류, Orderer 밸류 객체를 '주문' 애그리거트로 묶을 수 있음
- 리포지터리(REPOSITORY)
  - 도메인 모델의 영속성 처리
  - 예를 들어 DBMS 테이블에서 엔티티 객체를 로딩하거나 저장하는 기능 제공
- 도메인 서비스(DOMAIN SERVICE)
  - 특정 엔티티에 속하지 않은 도메인 로직 제공
  - 예를 들어 '할인 금액 계산'은 상품, 쿠폰, 회원 등급, 구매 금액 등 다양한 조건을 이용해서 구현하게 되는데, 이렇게 도메인 로직이 여러 엔티티와 밸류를 필요로 하면 도메인 서비스에서 로직 구현

## 2.4.1 엔티티와 밸류

도메인 모델의 엔티티와 DB 모델의 엔티티는 서로 다른 것이다.  
이 두 모델의 가장 큰 차이점은 다음과 같다.

- 도메인 모델의 엔티티는 데이터와 함께 도메인 기능을 함께 제공함
  - 도메인 모델의 엔티티는 단순히 데이터를 담고 있는 데이터 구조라기보다는 데이터와 함께 기능을 제공하는 객체임
  - 도메인 관점에서 기능을 구현하고 기능 구현을 캡슐화해서 데이터가 임의로 변경되는 것을 막음
- 도메인 모델의 엔티티는 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입을 이용해서 표현할 수 있음
  - RDBMS와 같은 관계형 데이터베이스는 밸류 타입을 제대로 표현하기 어려움

도메인 모델의 엔티티는 단순히 데이터를 담고 있는 데이터 구조라기보다는 데이터와 함께 기능을 제공하는 객체이다.  
도메인 관점에서 기능을 구현하고 기능 구현을 캡슐화해서 데이터가 임의로 변경되는 것을 막는다.

## 2.4.2 애그리거트

도메인이 커질수록 개발할 도메인 모델도 커지면서 많은 엔티티와 밸류가 출현한다.  
엔티티와 밸류 개수가 많아질수록 모델은 점점 더 복잡해진다.

도메인 모델이 복잡해지면 개발자가 전체 구조가 아닌 한 개 엔티티와 밸류에만 집중하는 상황이 발생한다.  
이때 상위 수준에서 모델을 관리하지 않고 개별 요소에만 초점을 맞추다 보면, 큰 수준에서 모델을 이해하지 못해 큰 틀에서 모델을 관리할 수 없는 상황에 빠진다.

도메인 모델은 개별 객체뿐 아니라 상위 수준에서 모델을 볼 수 있어야 전체 모델의 관계와 개별 모델을 이해하는 데 도움이 된다.  
도메인 모델에서 전체 구조를 이해하는 데 도움이 되는 것이 바로 `애그리거트(Aggregate)`이다.  
애그리거트는 **관련 객체를 하나로 묶은 군집**이다.  
주문이라는 도메인 개념은 '주문', '배송지 정보', '주문자', '주문 목록', '총 결제 금액'의 하위 모델로 구성된다.  
이 하위 개념을 표현한 모델을 하나로 묶어서 '주문'이라는 상위 개념으로 표현할 수 있다.

애그리거트를 사용하면 개별 객체가 아닌 관련 객체를 묶어서 객체 군집 단위로 모델을 바라볼 수 있게 된다.  
개별 객체 간의 관계가 아닌 애그리거트 간의 관계로 도메인 모델을 이해하고 구현하게 되며, 이를 통해 큰 틀에서 도메인 모델을 관리할 수 있다.

애그리거트를 구현할 때는 고려할 것이 많다.  
애그리거트를 어떻게 구성했느냐에 따라 구현이 복잡해지기도 하고, 트랜잭션 범위가 달라지기도 한다.  
또한 선택한 구현 기술에 따라 애그리거트 구현에 제약이 생기기도 한다.

## 2.4.3 리포지터리

도메인 객체를 지속적으로 사용하려면 RDBMS, NoSQL, 로컬 파일과 같은 물리적인 저장소에 도메인 객체를 보관해야 한다.  
이를 위한 도메인 모델이 `리포지터리(Repository)`이다.  
엔티티나 밸류가 요구사항에서 도출되는 도메인 모델이라면 리포지터리는 구현을 위한 도메인 모델이다.

리포지터리는 **애그리거트 단위로 도메인 객체를 저장하고 조회하는 기능을 정의**한다.

도메인 모델을 사용해야 하는 코드는 리포지터리를 토해서 도메인 객체를 구한 뒤에 도메인 객체의 기능을 실행한다.  
도메인 모델 관점에서 리포지터리는 도메인 객체를 영속화하는 데 필요한 기능을 추상화한 것으로 고수준 모듈에 속한다.  
기반 기술을 이용해서 리포지터리를 구현한 클래스는 저수준 모듈로 인프라스트럭처 영역에 속한다.

응용 서비스는 의존 주입과 같은 방식을 이용해서 실제 리포지터리 구현 객체에 접근한다.  
응용 서비스와 리포지터리는 밀접한 관련이 있는데, 그 이유는 다음과 같다.

- 응용 서비스는 필요한 도메인 객체를 구하거나 저장할 때 리포지터리 사용
- 응용 서비스는 트랜잭션을 관리하는데, 트랜잭션 처리는 리포지터리 구현 기술의 영향을 받음

리포지터리를 사용하는 주체가 응용 서비스이기 때문에 리포지터리는 응용 서비스가 필요로 하는 메서드를 제공한다.  
다음 두 메서드가 기본이 된다.

- 애그리거트를 저장하는 메서드
- 애그리거트 루트 식별자로 애그리거트를 조회하는 메서드

이 외에 필요에 따라 delete(id)나 counts() 등의 메서드를 제공하기도 한다.
