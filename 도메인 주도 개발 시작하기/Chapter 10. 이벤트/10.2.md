# 10.2 이벤트 개요

이 절에서 사용하는 `이벤트(event)`라는 용어는 '과거에 벌어진 어떤 것'을 의미한다.  
예를 들어 사용자가 암호를 변경한 것을 '암호를 변경했음 이벤트'가 벌어졌다고 할 수 있다.

이벤트가 발생한다는 것은 상태가 변경됐다는 것을 의미한다.  
'암호 변경됨 이벤트'가 발생한 이유는 회원이 암호를 변경했기 때문이다.

이벤트는 발생하는 것에서 끝나지 않는다.  
이벤트가 발생하면 그 이벤트에 반응하여 원하는 동작을 수행하는 기능을 구현한다.

도메인 모델에서도 도메인의 상태 변경을 이벤트로 표한할 수 있다.  
보통 '~할 때', '~가 발생하면', '만약 ~하면'과 같은 요구사항은 도메인의 상태 변경과 관련된 경우가 많고 이런 요구사항을 이벤트를 이용해서 구현할 수 있다.  
예를 들어 '주문을 취소할 때 이메일을 보낸다'라는 요구사항에서 '주문을 취소할 때'는 주문이 취소 상태로 바뀌는 것을 의미하므로 '주문 취소됨 이벤트'를 통해서 구현할 수 있다.

## 10.2.1 이벤트 관련 구성요소

도메인 모델에 이벤트를 도입하려면 이벤트, 이벤트 생성 주체, 이벤트 디스패처(퍼블리셔), 이벤트 핸들러(구독자)를 구현해야 한다.  
도메인 모델에서 **이벤트 생성 주체는 엔티티, 밸류, 도메인 서비스와 같은 도메인 객체**이다.  
이들 도메인 객체는 도메인 로직을 실행해서 상태가 바뀌면 관련 이벤트를 발생시킨다.

이벤트 핸들러(handler)는 이벤트 생성 주체가 발생한 이벤트에 반응한다.  
이벤트 핸들러는 생성 주체가 발생한 이벤트를 전달받아 이벤트에 담긴 데이터를 이용해서 원하는 기능을 실행한다.  
예를 들어 '주문 취소됨 이벤트'를 받는 이벤트 핸들러는 해당 주문의 주문자에게 SMS로 주문 취소 사실을 통지할 수 있다.

이벤트 생성 주체와 이벤트 핸들러를 연결해 주는 것이 바로 이벤트 디스패처(dispatcher)다.  
이벤트 생성 주체는 이벤트를 생성해서 디스패처에 이벤트를 전달한다.  
**이벤트를 전달받은 디스패처는 해당 이벤트를 처리할 수 있는 핸들러에 이벤트를 전파**한다.  
이벤트 디스패처의 구현 방식에 따라 이벤트 생성과 처리를 동기나 비동기로 실행하게 된다.

## 10.2.2 이벤트의 구성

이벤트는 발생한 이벤트에 대한 정보를 담는다.  
이 정보는 다음을 포함한다.

- 이벤트 종류
  - 클래스 이름으로 이벤트 종류를 표현
- 이벤트 발생 시간
- 추가 데이터
  - 주문 번호, 신규 배송지 정보 등 이벤트와 관련된 정보

배송지를 변경할 때 발생하는 이벤트를 생각해 보자.  
이 이벤트를 위한 클래스는 다음과 같이 작성할 수 있다.

```java
// 이벤트는 현재 기준으로 과거(바로 직전이라도)에 벌어진 것을 표현하기 때문에 이벤트 이름에는 과거 시제 사용
public class ShippingInfoChangedEvent {
    private String orderNumber;
    private long timestamp;
    private ShippingInfo newShippingInfo;
}
```

이 이벤트를 발생하는 주체는 Order 애그리거트다.  
Order 애그리거트의 배송지 변경 기능을 구현한 메서드는 다음 코드처럼 배송지 정보를 변경한 뒤에 이 이벤트를 발생시킬 것이다.

```java
public class Order {
    public void changeShippingInfo(ShippingInfo newShippingInfo) {
        verifyNotYetShipped();
        setShippingInfo(newShippingInfo);
        Events.raise(new ShippingInfoChangedEvent(number, newShippingInfo));
    }
}
```

ShippingInfoChangedEvent를 처리하는 핸들러는 디스패처로부터 이벤트를 전달받아 필요한 작업을 수행한다.  
예를 들어 변경된 배송지 정보를 물류 서비스에 전송하는 핸들러는 다음과 같이 구현할 수 있다.

```java
public class ShippingInfoChangedHandler {
    @EventListener(ShippingInfoChangedEvent.class)
    public void handle(ShippingInfoChangedEvent evt) {
        shippingInfoSynchronizer.sync(evt.getOrderNumber(), evt.getNewShippingInfo());
    }
}
```

이벤트는 이벤트 핸들러가 작업을 수행하는 데 필요한 데이터를 담아야 한다.  
이 데이터가 부족하면 핸들러는 필요한 데이터를 읽기 위해 관련 API를 호출하거나 DB에서 데이터를 직접 읽어와야 한다.

## 10.2.3 이벤트 용도

이벤트는 크게 두 가지 용도로 쓰인다.

- 트리거(Trigger)
  - 도메인의 상태가 바뀔 때 다른 후처리가 필요하면 후처리를 실행하기 위한 트리거로 이벤트 사용
- 서로 다른 두 시스템 간의 데이터 동기화

## 10.2.4 이벤트 장점

이벤트를 사용하면 **서로 다른 도메인 로직이 섞이는 것을 방지**할 수 있다.  
이벤트 핸들러를 사용하면 **기능 확장이 용이**하다.  
도메인 로직에 영향 없이 기능을 확장할 수 있다.
