# 6.1 컨테이너 인프라 환경 모니터링하기

## 6.1.1 모니터링 도구 선택하기

프로메테우스와 그라파나는 오픈 소스 도구입니다.  
오픈 소스는 가능한 한 단일 도구에서 단일 기능만을 구현하는 것을 선호합니다.  
데이터 수집과 통합, 시각화는 서로 다른 영역이므로 이를 함께 구현하지 않으려는 경향이 있습니다.  
물론 서비스형 모니터링 도구는 사용자 편의를 위해 이러한 기능을 모아서 한꺼번에 제공합니다.  
그런데도 하나의 도구로 처리하지 않고 프로메테우스와 그라파나의 혼합 구조를 사용하는 이유는 다음과 같습니다.

1. 비용
    - 모니터링 대상마다 라이선스(Licence) 비용 발생
    - 클라우드 같은 곽므제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용 발생
2. 보안
    - 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링
    - 보안에 민감하여 내부에서 모든 데이터를 처리하려는 경우에는 사용하기 어려움

아래는 모니터링 도구의 종류입니다.

- `프로메테우스(Prometheus)`
    - 사운드클라우드(SoundCloud)에서 자사 서비스의 모니터링을 위해 개발한 도구
    - 현재는 오픈 소스로 전환돼 CNCF에서 관리
    - 시계열 데이터베이스를 내장하고 있으며 자체적인 질의 페이지 외에 시각화 기능은 없으나 그라파나와 연계하면 현업에서 사용할 수 있는 시각화 기능 제공
    - 중앙 서버에서 에이전트의 데이터를 수집하는 풀(Pull) 방식을 사용
- `데이터독(Datadog)`
    - **서비스형 소프트웨어(SaaS)** 형태로 제공
    - 웹사이트에서 모니터링 대상을 관리할 수 있고 쿠버네티스를 비롯해 여러 클라우드 서비스나 애플리케이션과 연결이 쉬우므로 관리 부담이 적음
    - 모니터링 대상마다 요금을 부과하기 때문에 모니터링 대상이 늘면 비용이 커짐
- `뉴 렐릭(New Relic)`
    - 데이터독과 같은 서비스형 소프트웨어
    - 데이터독과 비교했을 때 애플리케이션 성능 모니터링(APM, Application Performance Monitoring)에 더 특화돼 있음
    - 모니터링 대상이 많을수록 비용이 커짐
- `인플럭스DB(InfluxDB)`
    - 2013년 인플럭스데이터(Influxdata)에서 개발한 시계열(Time series) 데이터베이스
    - 오픈 소스로 공개된 무료 버전과 클라우드에서 바로 사용할 수 있는 서비스형 소프트웨어, 라이선스를 구매해 설치할 수 있는 엔터프라이즈 버전이 있음
    - 무료 버전은 프로메테우스와 유사하나 인플럭스DB가 쓰기 성능이 더 뛰어나 대량의 이벤트를 모니터링하는 데 좀 더 적합

프로메테우스와 인플럭스DB가 제공하는 대시보드는 서비스형으로 사용하는 데이터독과 뉴 렐릭보다 시각화 부분이 다소 약합니다.  
그래서 부족한 시각화 기능을 보강하는 다음과 같은 도구를 함께 사용합니다.

- `그라파나(Grafana)`
    - 그라파나 랩스(Grafana Labs)에서 개발했으며 특정 소프트웨어에 종속되지 않은 독립적인 시각화 도구
    - 30가지 이상의 다양한 수집 도구 및 데이터베이스들과 연계를 지원
    - 주로 시계열 데이터의 시각화에 많이 쓰지만, 관계형 데이터베이스 데이터를 표 형태로 시각화해 사용 가능
    - 기능을 확장하는 플러그인과 개별 사용자들이 만들어 둔 대시보드의 공유가 매우 활발하여 필요에 따라 적절히 선택해 사용 가능
    - 오픈 소스이기 때문에 사용자의 요구 사항에 맞게 수정이 가능하고 필요에 따라 설치형과 서비스형을 모두 선택 가능
- `키바나(Kibana)`
    - **일래스틱서치(ElasticSearch)** 를 개발한 일래스틱에서 만든 시각화 도구
    - 일래스틱서치에 적재된 데이터를 시각화하거나 검색하는 데 사용하고, 이러한 데이터를 분석할 때도 사용
    - 일래스틱서치의 데이터만을 시각화할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트(Metricbeat)라는 도구로 일래스틱서치에 전달해야 하는 불편함이 있음
    - 시각화 기능이 매우 강력해서 시각화를 중점적으로 다루는 경우에 사용하면 좋음
- `크로노그래프(Chronograf)`
    - 인플럭스DB를 개발한 인플럭스데이터에서 만든 시각화 도구
    - 오픈 소스로 제공돼 사용자의 편의에 맞게 수정 가능
    - 설치형과 서비스형을 모두 제공해 용도에 따라 선택 가능
    - 키바나와 마찬가지로 자사 제품인 인플럭스DB만 시각화 가능

## 6.1.2 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

쿠버네티스 노드는 kubelet을 통해 파드를 관리하며, 파드의 CPU나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 cAdvisor를 사용합니다.  
`cAdvisor`는 구글이 만든 컨테이너 메트릭 수집 도구로, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 이를 가공해서 kubelet에 전달하는 역할을 합니다.  
하지만 cAdvisor로 수집되고 kubelet으로 공개되는 데이터가 있어도 외부에서 이를 모아서 표현해 주는 도구가 없다면 의미가 없습니다.  
그래서 메트릭 데이터를 수집하는 목적으로 메트릭 서버를 설치해 HPA와 같은 기능을 구현하고 쿠버네티스 대시보드를 설치해 현재 상태를 확인할 수도 있습니다.  
이렇게 메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것을 `리소스 메트릭 파이프라인(Resource Metric Pipeline)`이라고 합니다.

하지만 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력됩니다.  
그래서 메트릭 데이터를 저장 공간에 따로 저장하는 `완전한 모니터링 파이프라인(Full Monitoring Pipeline)`으로 구축하기를 권장합니다.  
이 설계 방식을 반영한 도구가 프로메테우스입니다.

완전한 모니터링 파이프라인으로 구성한 프로메테우스는 여러 수집 대상이 공개하는 메트릭 데이터를 모아 시계열 데이터베이스에 저장합니다.  
저장된 데이터는 시간이 지나도 확인할 수 있는 영속적인 데이터입니다.  
누적된 메트릭 데이터로는 쿠버네티스 인프라의 상태 변화를 파악할 수 있고, 적절한 위험 감지 및 조치를 취할 수 있습니다.